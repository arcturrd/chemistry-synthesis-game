<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>СИНТЕЗ - Alchemy Grand Master</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Шрифти -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800;900&family=Cormorant+Garamond:wght@600;700&family=Montserrat:wght@800;900&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           1. ГЛОБАЛЬНІ НАЛАШТУВАННЯ ТА ФОНИ
           ========================================= */
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        body {
            font-family: 'Sans-serif', serif;
            background-color: #0d1f14; /* Глибокий алхімічний зелений */
            background-image: radial-gradient(#1a3c28 1px, transparent 1px);
            background-size: 24px 24px;
            color: #ecfdf5;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        /* =========================================
           2. ЗМІННІ КОЛЬОРІВ (Хімічні Елементи)
           ========================================= */
        :root {
            /* ОКСИГЕН (Червоний) */
            --main-O: #B71C1C; 
            --bg-O: radial-gradient(circle at center, #FFEBEE 0%, #EF9A9A 100%);
            
            /* ГІДРОГЕН (Блакитний/Сірий) */
            --main-H: #37474F; 
            --bg-H: radial-gradient(circle at center, #E3F2FD 0%, #90A4AE 100%);
            
            /* КАРБОН (Чорний/Сірий) */
            --main-C: #000000; 
            --bg-C: radial-gradient(circle at center, #E0E0E0 0%, #616161 100%);
            
            /* НАТРІЙ (Фіолетовий) */
            --main-Na: #4A148C; 
            --bg-Na: radial-gradient(circle at center, #F3E5F5 0%, #CE93D8 100%);
            
            /* КАЛЬЦІЙ (Помаранчевий) */
            --main-Ca: #BF360C; 
            --bg-Ca: radial-gradient(circle at center, #FFF3E0 0%, #FFCC80 100%);
            
            /* ХЛОР (Зелений) */
            --main-Cl: #1B5E20; 
            --bg-Cl: radial-gradient(circle at center, #E8F5E9 0%, #A5D6A7 100%);
            
            /* НІТРОГЕН (Синій) */
            --main-N: #1A237E; 
            --bg-N: radial-gradient(circle at center, #E8EAF6 0%, #9FA8DA 100%);
            
            /* СУЛЬФУР (Жовтий) */
            --main-S: #F57F17; 
            --bg-S: radial-gradient(circle at center, #FFFDE7 0%, #FFF59D 100%);
            
            /* СИЛІЦІЙ (Коричневий) */
            --main-Si: #3E2723; 
            --bg-Si: radial-gradient(circle at center, #EFEBE9 0%, #BCAAA4 100%);

            /* МОЛЕКУЛИ (Золото) */
            --gold-front: radial-gradient(circle at center, #fffdf5 0%, #fceeb5 100%);
            --green-classic: #006400;
        }

        /* =========================================
           3. ДЕТАЛІЗОВАНІ СТИЛІ КАРТКИ ЕЛЕМЕНТА
           ========================================= */
        .card-element {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 2px 4px 10px rgba(0,0,0,0.5);
            transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            background: #fff;
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        .card-element .texture {
            position: absolute; 
            inset: 0; 
            opacity: 0.3; 
            mix-blend-mode: multiply;
            background-image: url("https://www.transparenttextures.com/patterns/stardust.png");
            pointer-events: none;
        }

        .card-element .card-border-inner {
            position: absolute; 
            top: 4px; left: 4px; right: 4px; bottom: 4px;
            border: 2px solid rgba(255,255,255,0.6);
            border-radius: 8px; 
            pointer-events: none;
        }

        .corner-circle {
            position: absolute; 
            width: 24px; height: 24px;
            background: rgba(255,255,255,0.95);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.25);
            font-family: 'Montserrat', sans-serif; 
            font-weight: 800; 
            font-size: 10px;
            z-index: 10;
        }
        .tl { top: 7px; left: 7px; }
        .tr { top: 7px; right: 7px; }
        .bl { bottom: 7px; left: 7px; }
        .br { bottom: 7px; right: 7px; }

        .center-ring {
            position: absolute; 
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 68%; 
            aspect-ratio: 1/1;
            background: rgba(255,255,255,0.8);
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.9);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 5;
            backdrop-filter: blur(4px);
        }

        .symbol-main {
            font-family: 'Playfair Display', serif;
            font-weight: 900; font-size: 2.2rem; line-height: 1;
        }
        
        .name-ua {
            font-family: 'Cormorant Garamond', serif;
            font-weight: 700; font-size: 0.7rem; 
            text-transform: uppercase; letter-spacing: 0.05em;
            margin-top: 4px;
        }

        /* =========================================
           4. ДЕТАЛІЗОВАНІ СТИЛІ КАРТКИ МОЛЕКУЛИ
           ========================================= */
        .card-molecule {
            position: relative;
            background: var(--gold-front);
            border-radius: 14px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.6);
            overflow: hidden;
            display: flex; flex-direction: column;
            border: 1px solid #c9b675;
            transition: all 0.3s ease;
        }

        .card-molecule .pattern-bg {
            position: absolute; inset: 0;
            background-image: radial-gradient(#d4b062 1px, transparent 1px);
            background-size: 10px 10px; opacity: 0.25;
            pointer-events: none;
        }

        .card-molecule .card-border-double {
            position: absolute; inset: 5px;
            border: 3px double var(--green-classic);
            border-radius: 10px; 
            pointer-events: none; 
            z-index: 2;
        }

        .mol-points {
            position: absolute; top: 0; right: 0;
            background: var(--green-classic); color: #fffdf5;
            font-family: 'Montserrat', sans-serif; font-weight: 900;
            font-size: 0.85rem; padding: 5px 12px;
            border-bottom-left-radius: 14px;
            border-left: 2px solid #fffdf5; border-bottom: 2px solid #fffdf5;
            z-index: 10; 
            box-shadow: -2px 2px 5px rgba(0,0,0,0.25);
        }

        .mol-formula {
            margin-top: 35px;
            font-family: 'Playfair Display', serif;
            font-weight: 900; font-size: 1.9rem;
            color: #1a1a1a; text-align: center;
            text-shadow: 1px 1px 0px rgba(255,255,255,0.6);
            z-index: 5;
            line-height: 1.2;
        }

        .mol-names {
            text-align: center; margin-top: auto; margin-bottom: 15px; z-index: 5;
        }
        .mol-name-trivial {
            font-family: 'Montserrat', sans-serif; font-weight: 800;
            text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.08em;
            color: #3e2723;
        }

        .mol-recipe {
            background: rgba(0, 100, 0, 0.06);
            padding: 10px;
            display: flex; justify-content: center; gap: 5px; flex-wrap: wrap;
            border-top: 1px solid rgba(0, 100, 0, 0.15);
            z-index: 5;
            min-height: 45px;
            align-items: center;
        }
        
        .atom-dot {
            width: 22px; height: 22px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Montserrat', sans-serif; font-weight: 800; font-size: 9px;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.7);
        }

        /* =========================================
           5. АНІМАЦІЇ ТА УТИЛІТИ
           ========================================= */
        #error-overlay {
            display: none; position: fixed; inset: 0; background: white; z-index: 9999; padding: 20px; color: red;
        }
        
        .animate-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div id="error-overlay">
        <h2 class="text-xl font-bold mb-2">⚠️ Критична помилка:</h2>
        <pre id="error-msg" class="whitespace-pre-wrap font-mono text-xs"></pre>
        <button onclick="window.location.reload()" class="mt-4 bg-green-700 text-white px-4 py-2 rounded">Перезавантажити гру</button>
    </div>
    
    <div id="root"></div>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            document.getElementById('error-overlay').style.display = 'block';
            document.getElementById('error-msg').innerText = `${msg}\nLocation: ${line}:${col}\n${error?.stack}`;
        };
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, 
            arrayUnion, runTransaction, increment 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { 
            getAuth, signInAnonymously, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        
        // Icon Imports
        import { 
            FlaskConical, ArrowRightLeft, Crown, LogOut, Loader2, X, 
            History, Trash2, RefreshCcw, CheckCircle2, Menu, Plus, Minus, User, Info, Scale, Trophy
        } from 'https://esm.sh/lucide-react@0.263.1';

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAEownlzJ0AqrnAku7Cw208N2DRLQHdD6Y",
            authDomain: "synthesis-game-f9684.firebaseapp.com",
            projectId: "synthesis-game-f9684",
            storageBucket: "synthesis-game-f9684.firebasestorage.app",
            messagingSenderId: "257683012244",
            appId: "1:257683012244:web:c7aee7e27c929ceb5b9281"
        };

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase initialized successfully");
        } catch (e) {
            console.error("Firebase initialization failed:", e);
        }

        const appId = 'synthesis-game';
        const WINNING_SCORE = 50;

        // --- DATA DICTIONARIES ---
        const ELEMENTS = {
            'H':  { m: 1,  name: 'Гідроген' },
            'O':  { m: 16, name: 'Оксиген' },
            'C':  { m: 12, name: 'Карбон' },
            'N':  { m: 14, name: 'Нітроген' },
            'Na': { m: 23, name: 'Натрій' },
            'Cl': { m: 35.5, name: 'Хлор' }, // 35.5 Special Case
            'Ca': { m: 40, name: 'Кальцій' },
            'S':  { m: 32, name: 'Сульфур' },
            'Si': { m: 28, name: 'Силіцій' },
        };

        const ELEMENT_DISTRIBUTION = {
            'H': 24, 'O': 34, 'C': 12, 'Na': 10, 'Cl': 7, 'Ca': 8, 'N': 7, 'S': 6, 'Si': 4
        };

        const MOLECULES_LIST = [
            { id: 'h2o',     f: 'H₂O',      name: 'Вода',              vp: 3, count: 6, req: { 'H': 2, 'O': 1 } },
            { id: 'co',      f: 'CO',       name: 'Чадний газ',        vp: 4, count: 4, req: { 'C': 1, 'O': 1 } },
            { id: 'hcl',     f: 'HCl',      name: 'Хлоридна к-та',     vp: 6, count: 3, req: { 'H': 1, 'Cl': 1 } },
            { id: 'cao',     f: 'CaO',      name: 'Негашене вапно',    vp: 4, count: 3, req: { 'Ca': 1, 'O': 1 } },
            { id: 'co2',     f: 'CO₂',      name: 'Вуглекислий газ',   vp: 5, count: 5, req: { 'C': 1, 'O': 2 } },
            { id: 'nacl',    f: 'NaCl',     name: 'Кухонна сіль',      vp: 8, count: 4, req: { 'Na': 1, 'Cl': 1 } },
            { id: 'naoh',    f: 'NaOH',     name: 'Каустична сода',    vp: 5, count: 3, req: { 'Na': 1, 'O': 1, 'H': 1 } },
            { id: 'nh3',     f: 'NH₃',      name: 'Аміак',             vp: 8, count: 2, req: { 'N': 1, 'H': 3 } },
            { id: 'h2o2',    f: 'H₂O₂',     name: 'Перекис водню',     vp: 4, count: 2, req: { 'H': 2, 'O': 2 } },
            { id: 'so2',     f: 'SO₂',      name: 'Сірчистий газ',     vp: 4, count: 2, req: { 'S': 1, 'O': 2 } },
            { id: 'sio2',    f: 'SiO₂',     name: 'Пісок',             vp: 10, count: 2, req: { 'Si': 1, 'O': 2 } },
            { id: 'caoh2',   f: 'Ca(OH)₂',  name: 'Гашене вапно',      vp: 7, count: 2, req: { 'Ca': 1, 'O': 2, 'H': 2 } },
            { id: 'h2so4',   f: 'H₂SO₄',    name: 'Сульфатна к-та',    vp: 12, count: 1, req: { 'H': 2, 'S': 1, 'O': 4 } },
            { id: 'caco3',   f: 'CaCO₃',    name: 'Крейда',            vp: 9, count: 3, req: { 'Ca': 1, 'C': 1, 'O': 3 } },
            { id: 'nahco3',  f: 'NaHCO₃',   name: 'Харчова сода',      vp: 10, count: 3, req: { 'Na': 1, 'H': 1, 'C': 1, 'O': 3 } },
            { id: 'na2co3',  f: 'Na₂CO₃',   name: 'Кальцинована сода', vp: 12, count: 3, req: { 'Na': 2, 'C': 1, 'O': 3 } },
        ];

        // --- HELPER FUNCTIONS ---
        const shuffleArray = (array) => {
            let arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        };

        const generateElementDeck = () => {
            let deck = [];
            Object.entries(ELEMENT_DISTRIBUTION).forEach(([el, count]) => {
                for (let i = 0; i < count; i++) deck.push(el);
            });
            return shuffleArray(deck);
        };

        const generateMoleculeDeck = () => {
            let deck = [];
            MOLECULES_LIST.forEach(mol => {
                for (let i = 0; i < (mol.count || 1); i++) {
                    deck.push({ ...mol, uniqueId: `${mol.id}_${Math.random().toString(36).substr(2, 8)}` });
                }
            });
            return shuffleArray(deck);
        };

        const checkRecipe = (hand, recipe) => {
            const handCounts = {};
            hand.forEach(el => handCounts[el] = (handCounts[el] || 0) + 1);
            for (const [el, needed] of Object.entries(recipe)) {
                if (!handCounts[el] || handCounts[el] < needed) return false;
            }
            return true;
        };

        const getAtomsList = (req) => {
            let list = [];
            Object.entries(req).forEach(([el, count]) => {
                for(let i=0; i<count; i++) list.push(el);
            });
            return list;
        };

        // --- UI COMPONENTS ---

        const ElementCard = ({ type, onClick, selected = false, style, overlap = false, mini = false }) => {
            const data = ELEMENTS[type] || { m: '?', name: type };
            const cardStyle = { 
                background: `var(--bg-${type})`, 
                color: `var(--main-${type})` 
            };
            const textStyle = { 
                color: `var(--main-${type})` 
            };

            if (mini) {
                return (
                    <div onClick={onClick} className={`relative w-12 h-16 rounded-md border shadow-sm flex flex-col items-center justify-center cursor-pointer transition-transform ${selected ? 'ring-2 ring-yellow-500 scale-110 z-10' : 'hover:scale-105'}`} style={cardStyle}>
                        <span className="font-bold font-serif text-lg">{type}</span>
                    </div>
                );
            }

            return (
                <div 
                    onClick={onClick}
                    style={{...style, ...cardStyle}}
                    className={`
                        card-element
                        relative w-24 h-36 flex-shrink-0 cursor-pointer select-none
                        ${selected ? '-translate-y-8 z-30 ring-4 ring-yellow-400 border-yellow-500 shadow-yellow-500/50' : 'hover:-translate-y-4 hover:z-20'}
                        ${overlap ? '-ml-12 hover:ml-0' : ''}
                    `}
                >
                    <div className="texture"></div>
                    <div className="card-border-inner"></div>

                    <div className="corner-circle tl" style={textStyle}>{type}</div>
                    <div className="corner-circle tr" style={textStyle}>{data.m}</div>
                    <div className="corner-circle bl" style={textStyle}>{data.m}</div>
                    <div className="corner-circle br" style={textStyle}>{type}</div>

                    <div className="center-ring" style={{color: `var(--main-${type})`}}>
                        <div className="symbol-main">{type}</div>
                        <div className="name-ua">{data.name}</div>
                    </div>
                </div>
            );
        };

        const MoleculeCard = ({ mol, canBuy, onBuy }) => {
            const atoms = getAtomsList(mol.req);
            
            return (
                <div 
                    onClick={() => canBuy && onBuy(mol)}
                    className={`
                        card-molecule
                        w-[45%] sm:w-40 min-h-[200px] sm:min-h-[220px]
                        transition-all duration-300
                        ${canBuy ? 'scale-105 cursor-pointer z-10 shadow-[0_0_20px_rgba(255,215,0,0.6)] ring-2 ring-yellow-400' : 'opacity-95'}
                    `}
                >
                    <div className="pattern-bg"></div>
                    <div className="card-border-double"></div>

                    <div className="mol-points">{mol.vp} VP</div>
                    <div className="mol-formula">{mol.f}</div>
                    <div className="mol-names">
                        <div className="mol-name-trivial">{mol.name}</div>
                    </div>

                    <div className="mol-recipe">
                        {atoms.map((el, i) => (
                            <div key={i} className="atom-dot" style={{background: `var(--bg-${el})`, color: `var(--main-${el})`, borderColor: `var(--main-${el})`}}>
                                {el}
                            </div>
                        ))}
                    </div>

                    {canBuy && (
                        <div className="absolute inset-0 bg-green-900/20 flex items-center justify-center backdrop-blur-[1px] z-20 animate-pulse">
                            <div className="bg-green-700 text-white px-4 py-2 rounded-full shadow-xl font-black text-xs uppercase tracking-widest flex items-center gap-2 border-2 border-green-500">
                                <FlaskConical size={14}/> СИНТЕЗУВАТИ
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="bg-[#fcfcfc] rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden border-2 border-green-800 flex flex-col max-h-[90vh]">
                        <div className="bg-green-900 px-6 py-4 border-b border-green-800 flex justify-between items-center shrink-0">
                            <h3 className="text-xl font-bold text-yellow-50 font-serif">{title}</h3>
                            <button onClick={onClose} className="p-2 hover:bg-green-800 rounded-full text-green-200 transition-colors">
                                <X size={24}/>
                            </button>
                        </div>
                        <div className="p-6 bg-[#f0fdf4] overflow-y-auto">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // --- GAME LOGIC COMPONENT ---

        const SynthesisGame = () => {
            // STATE
            const [user, setUser] = useState(null);
            const [gameId, setGameId] = useState(localStorage.getItem('lastGameId') || '');
            const [gameData, setGameData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [playerName, setPlayerName] = useState(localStorage.getItem('playerName') || '');
            
            // UI State
            const [selectedCards, setSelectedCards] = useState([]);
            const [notification, setNotification] = useState(null);
            const [targetGameId, setTargetGameId] = useState('');
            
            // Trade State
            const [isTradeModalOpen, setTradeModalOpen] = useState(false);
            const [tradeTab, setTradeTab] = useState('bank');
            const [tradeWant, setTradeWant] = useState([]);
            const [tradeTargetPlayer, setTradeTargetPlayer] = useState(null);

            // Auth Effect
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        await signInAnonymously(auth);
                    } catch (e) {
                        showNotification('error', "Помилка входу в систему");
                    }
                };
                initAuth();
                return onAuthStateChanged(auth, setUser);
            }, []);

            // Game Sync Effect
            useEffect(() => {
                if (!gameId || !db) return;
                const unsub = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), (snap) => {
                    if (snap.exists()) {
                        setGameData(snap.data());
                    } else {
                        setGameData(null);
                        setGameId('');
                        localStorage.removeItem('lastGameId');
                        showNotification('error', 'Кімнату не знайдено або закрито');
                    }
                });
                return () => unsub();
            }, [gameId]);

            // Computed Values
            const myIndex = gameData?.players.findIndex(p => p.uid === user?.uid) ?? -1;
            const myPlayer = myIndex !== -1 ? gameData.players[myIndex] : null;
            const isMyTurn = gameData?.status === 'playing' && gameData?.turnIndex === myIndex;
            const isHost = gameData?.players[0].uid === user?.uid;
            
            const turnPhase = gameData?.turnPhase; 
            const isDiscardPhase = turnPhase === 'discard_force' && isMyTurn;
            
            // Discard Logic: If cards > 10, discard floor(count / 2)
            const calculateCardsToDiscard = () => {
                if (!myPlayer) return 0;
                if (myPlayer.hand.length > 10) {
                    return Math.floor(myPlayer.hand.length / 2);
                }
                return 0;
            };
            const cardsToDiscard = isDiscardPhase ? calculateCardsToDiscard() : 0;

            // --- ACTIONS ---

            const showNotification = (type, msg) => {
                setNotification({ type, msg });
                setTimeout(() => setNotification(null), 3000);
            };

            const leaveGame = () => {
                if(confirm("Ви дійсно хочете покинути поточну гру?")) {
                    setGameId('');
                    setGameData(null);
                    localStorage.removeItem('lastGameId');
                    // Reset local UI state
                    setSelectedCards([]);
                    setTradeModalOpen(false);
                }
            };

            const createGame = async () => {
                if (!playerName.trim()) return showNotification('error', "Введіть ваше ім'я!");
                setLoading(true);
                localStorage.setItem('playerName', playerName);
                
                const gid = Math.random().toString(36).substring(2, 6).toUpperCase();
                const molDeck = generateMoleculeDeck();
                const market = molDeck.splice(0, 4); 
                
                const initialData = {
                    id: gid,
                    status: 'waiting', 
                    players: [{
                        uid: user.uid,
                        name: playerName,
                        hand: [],
                        score: 0,
                        molecules: []
                    }],
                    elementDeck: generateElementDeck(),
                    moleculeDeck: molDeck,
                    market: market,
                    turnIndex: 0,
                    turnPhase: 'draw',
                    activeTrade: null,
                    logs: [{ text: `Алхімік ${playerName} відкрив нову лабораторію`, time: Date.now() }]
                };

                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gid), initialData);
                setGameId(gid);
                localStorage.setItem('lastGameId', gid);
                setLoading(false);
            };

            const joinGame = async (code) => {
                if (!playerName.trim()) return showNotification('error', "Введіть ваше ім'я!");
                setLoading(true);
                localStorage.setItem('playerName', playerName);
                
                const gid = code.toUpperCase().trim();
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'games', gid);
                
                try {
                    await runTransaction(db, async (t) => {
                        const s = await t.get(ref);
                        if (!s.exists()) throw "Кімнати не існує";
                        const d = s.data();
                        
                        if (d.status !== 'waiting') throw "Гра вже почалась";
                        if (d.players.length >= 4) throw "Кімната переповнена";
                        
                        if (!d.players.some(p => p.uid === user.uid)) {
                            t.update(ref, {
                                players: arrayUnion({ uid: user.uid, name: playerName, hand: [], score: 0, molecules: [] }),
                                logs: arrayUnion({ text: `${playerName} приєднався до експерименту`, time: Date.now() })
                            });
                        }
                    });
                    setGameId(gid);
                    localStorage.setItem('lastGameId', gid);
                } catch (e) {
                    showNotification('error', typeof e === 'string' ? e : e.message);
                }
                setLoading(false);
            };

            const startGame = async () => {
                const deck = [...gameData.elementDeck];
                const players = gameData.players.map(p => ({ ...p, hand: deck.splice(0, 5) }));
                
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                    status: 'playing',
                    elementDeck: deck,
                    players: players,
                    turnPhase: 'draw',
                    logs: arrayUnion({ text: 'Експеримент почався! Роздано по 5 елементів.', time: Date.now() })
                });
            };

            const drawCards = async () => {
                if (!isMyTurn || turnPhase !== 'draw') return;
                
                let deck = [...gameData.elementDeck];
                if (deck.length < 2) {
                     showNotification('error', 'Колода елементів вичерпана!'); 
                     return; 
                }

                const drawn = deck.splice(0, 2);
                const players = [...gameData.players];
                players[myIndex].hand.push(...drawn);
                
                const nextPhase = players[myIndex].hand.length > 10 ? 'discard_force' : 'action';

                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                    elementDeck: deck,
                    players: players,
                    turnPhase: nextPhase,
                    logs: arrayUnion({ text: `${myPlayer.name} отримав нові елементи`, time: Date.now() })
                });
            };

            const discardCards = async () => {
                if (selectedCards.length !== cardsToDiscard) {
                    return showNotification('error', `Необхідно скинути рівно ${cardsToDiscard} карт!`);
                }
                
                let hand = [...myPlayer.hand];
                selectedCards.sort((a,b)=>b-a).forEach(i => hand.splice(i, 1));
                
                const players = [...gameData.players];
                players[myIndex].hand = hand;

                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                    players: players,
                    turnPhase: 'action',
                    logs: arrayUnion({ text: `${myPlayer.name} очистив інвентар (${cardsToDiscard} карт)`, time: Date.now() })
                });
                setSelectedCards([]);
            };

            const synthesizeMolecule = async (mol) => {
                if (!checkRecipe(myPlayer.hand, mol.req)) return;

                let hand = [...myPlayer.hand];
                Object.entries(mol.req).forEach(([el, cnt]) => {
                    for(let i=0; i<cnt; i++) {
                        const idx = hand.indexOf(el);
                        if (idx > -1) hand.splice(idx, 1);
                    }
                });

                const players = [...gameData.players];
                players[myIndex] = {
                    ...myPlayer,
                    hand: hand,
                    molecules: [...myPlayer.molecules, mol.id],
                    score: myPlayer.score + mol.vp
                };

                const market = [...gameData.market];
                const marketIdx = market.findIndex(m => m.uniqueId === mol.uniqueId);
                market.splice(marketIdx, 1);
                
                const molDeck = [...gameData.moleculeDeck];
                if (molDeck.length > 0) market.push(molDeck.shift());

                // WIN CONDITION CHECK
                const status = players[myIndex].score >= WINNING_SCORE ? 'finished' : 'playing';

                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                    players: players,
                    market: market,
                    moleculeDeck: molDeck,
                    status: status,
                    logs: arrayUnion({ text: `${myPlayer.name} синтезував ${mol.name} (+${mol.vp} VP)`, time: Date.now() })
                });
            };

            const endTurn = async () => {
                const nextIndex = (gameData.turnIndex + 1) % gameData.players.length;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                    turnIndex: nextIndex,
                    turnPhase: 'draw',
                    activeTrade: null,
                    logs: arrayUnion({ text: `Хід переходить далі до ${gameData.players[nextIndex].name}`, time: Date.now() })
                });
            };

            // --- TARGETED TRADE LOGIC ---

            const addToTradeWant = (el) => setTradeWant(prev => [...prev, el]);
            const removeFromTradeWant = (idx) => setTradeWant(prev => prev.filter((_, i) => i !== idx));
            const selectTradeTarget = (uid) => setTradeTargetPlayer(uid === tradeTargetPlayer ? null : uid);

            const executeBankTrade = async () => {
                if (selectedCards.length !== 3) return showNotification('error', "Оберіть 3 карти у себе в руці!");
                const first = myPlayer.hand[selectedCards[0]];
                if (!selectedCards.every(i => myPlayer.hand[i] === first)) return showNotification('error', "Для банку карти мають бути однакові!");
                if (tradeWant.length !== 1) return showNotification('error', "Оберіть 1 карту для отримання!");

                let hand = [...myPlayer.hand];
                selectedCards.sort((a,b)=>b-a).forEach(i => hand.splice(i, 1));
                hand.push(tradeWant[0]);

                const players = [...gameData.players];
                players[myIndex].hand = hand;

                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                    players: players,
                    logs: arrayUnion({ text: `${myPlayer.name} обміняв 3 ${first} на ${tradeWant[0]} (Банк)`, time: Date.now() })
                });
                
                setTradeModalOpen(false); setSelectedCards([]); setTradeWant([]);
            };

            const createPlayerTrade = async () => {
                if (selectedCards.length === 0) return showNotification('error', "Спочатку оберіть карти в руці, які ви віддаєте!");
                if (tradeWant.length === 0) return showNotification('error', "Оберіть карти, які ви хочете!");
                if (!tradeTargetPlayer) return showNotification('error', "Оберіть партнера для обміну!");
                
                const giveCards = selectedCards.map(i => myPlayer.hand[i]);
                const targetName = gameData.players.find(p => p.uid === tradeTargetPlayer)?.name || "Невідомий";

                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                    activeTrade: {
                        initiator: user.uid,
                        target: tradeTargetPlayer, // TARGETED
                        give: giveCards,
                        want: tradeWant
                    },
                    logs: arrayUnion({ text: `${myPlayer.name} надсилає пропозицію обміну гравцю ${targetName}`, time: Date.now() })
                });

                setTradeModalOpen(false); setSelectedCards([]); setTradeWant([]); setTradeTargetPlayer(null);
            };

            const acceptActiveTrade = async () => {
                const tr = gameData.activeTrade;
                if (!tr || tr.target !== user.uid) return;
                
                let acceptorHand = [...myPlayer.hand];
                const handCounts = {};
                acceptorHand.forEach(c => handCounts[c] = (handCounts[c]||0) + 1);
                
                const neededCounts = {};
                tr.want.forEach(c => neededCounts[c] = (neededCounts[c]||0) + 1);

                for (let el in neededCounts) {
                    if (!handCounts[el] || handCounts[el] < neededCounts[el]) {
                        return showNotification('error', `У вас не вистачає карти: ${el}`);
                    }
                }

                const initIdx = gameData.players.findIndex(p => p.uid === tr.initiator);
                const initiator = gameData.players[initIdx];
                let initiatorHand = [...initiator.hand];

                tr.want.forEach(card => {
                    const idx = acceptorHand.indexOf(card);
                    if (idx > -1) acceptorHand.splice(idx, 1);
                });
                initiatorHand.push(...tr.want);

                tr.give.forEach(card => {
                    const idx = initiatorHand.indexOf(card);
                    if (idx > -1) initiatorHand.splice(idx, 1);
                    acceptorHand.push(card);
                });

                const players = [...gameData.players];
                players[myIndex].hand = acceptorHand;
                players[initIdx].hand = initiatorHand;

                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                    players: players,
                    activeTrade: null,
                    logs: arrayUnion({ text: `Обмін успішно завершено: ${initiator.name} ↔ ${myPlayer.name}`, time: Date.now() })
                });
            };
            
            const rejectActiveTrade = async () => {
                 await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                    activeTrade: null,
                    logs: arrayUnion({ text: `${myPlayer.name} відхилив пропозицію обміну`, time: Date.now() })
                });
            };

            const canIAcceptTrade = (trade) => {
                if (!trade || trade.target !== user.uid || !myPlayer) return false;
                
                const myCounts = {}; 
                myPlayer.hand.forEach(c => myCounts[c] = (myCounts[c]||0)+1);
                const wantCounts = {}; 
                trade.want.forEach(c => wantCounts[c] = (wantCounts[c]||0)+1);
                
                for (let el in wantCounts) {
                    if (!myCounts[el] || myCounts[el] < wantCounts[el]) return false;
                }
                return true;
            };

            const openTradeModal = () => {
                setTradeWant([]); 
                setTradeTargetPlayer(null);
                setTradeModalOpen(true);
            };

            // --- RENDER ---

            if (loading) {
                return <div className="h-screen w-full bg-[#0d1f14] flex items-center justify-center"><Loader2 className="animate-spin text-yellow-500" size={64}/></div>;
            }

            // LOBBY
            if (!gameData) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 bg-cover bg-center">
                        <div className="bg-[#0d1f14]/90 backdrop-blur-md p-8 rounded-3xl shadow-2xl w-full max-w-md border-2 border-yellow-700">
                            <h1 className="text-6xl font-black text-center text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600 mb-8 font-serif">СИНТЕЗ</h1>
                            
                            <input 
                                type="text" 
                                placeholder="Ім'я Алхіміка" 
                                className="w-full p-4 bg-[#06120a] border-2 border-green-800 rounded-xl mb-4 text-yellow-100 font-bold text-center font-serif placeholder-green-800 focus:border-yellow-500 outline-none transition-colors"
                                value={playerName}
                                onChange={e => setPlayerName(e.target.value)}
                            />
                            
                            <button onClick={createGame} className="w-full py-4 bg-green-800 hover:bg-green-700 text-white rounded-xl font-bold mb-4 font-serif tracking-widest border-b-4 border-green-950 active:border-b-0 active:translate-y-1 transition-all">
                                СТВОРИТИ ГРУ
                            </button>
                            
                            <div className="flex gap-2">
                                <input 
                                    type="text" 
                                    placeholder="КОД КІМНАТИ" 
                                    className="w-2/3 p-4 bg-[#06120a] border-2 border-green-800 rounded-xl font-mono text-center text-yellow-100 font-bold tracking-[0.2em] outline-none"
                                    value={targetGameId}
                                    onChange={e => setTargetGameId(e.target.value)}
                                />
                                <button onClick={() => joinGame(targetGameId)} className="flex-1 bg-yellow-700 hover:bg-yellow-600 text-white rounded-xl font-bold border-b-4 border-yellow-900 active:border-b-0 active:translate-y-1 transition-all flex items-center justify-center">
                                    <ArrowRightLeft />
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // GAME OVER
            if (gameData.status === 'finished') {
                const sortedPlayers = [...gameData.players].sort((a,b) => b.score - a.score);
                return (
                    <div className="min-h-screen bg-[#0d1f14] flex flex-col items-center justify-center p-4 relative overflow-hidden">
                        <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-30 animate-pulse"></div>
                        
                        <div className="bg-[#1a3c28] p-8 rounded-3xl border-4 border-yellow-500 shadow-2xl max-w-lg w-full z-10 text-center relative">
                            <div className="absolute -top-10 left-1/2 -translate-x-1/2">
                                <Trophy size={80} className="text-yellow-400 drop-shadow-[0_0_15px_rgba(250,204,21,0.6)]" />
                            </div>

                            <h1 className="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600 mt-10 mb-2 font-serif uppercase tracking-widest">
                                ГРУ ЗАВЕРШЕНО
                            </h1>
                            <p className="text-green-300 font-serif mb-8 text-lg">Вітаємо переможця!</p>

                            <div className="space-y-4 mb-8">
                                {sortedPlayers.map((p, i) => (
                                    <div key={i} className={`
                                        flex items-center gap-4 p-4 rounded-2xl border-2
                                        ${i === 0 
                                            ? 'bg-gradient-to-r from-yellow-900/50 to-yellow-800/50 border-yellow-500 shadow-lg transform scale-105' 
                                            : 'bg-[#0d1f14] border-green-800 opacity-80'}
                                    `}>
                                        <div className={`
                                            w-12 h-12 rounded-full flex items-center justify-center font-bold text-xl border-2
                                            ${i === 0 ? 'bg-yellow-500 text-black border-yellow-300' : 'bg-green-900 text-green-300 border-green-700'}
                                        `}>
                                            {i + 1}
                                        </div>
                                        <div className="flex-1 text-left">
                                            <div className={`font-bold text-xl font-serif ${i===0 ? 'text-yellow-100' : 'text-green-100'}`}>{p.name}</div>
                                            {i === 0 && <div className="text-xs text-yellow-400 uppercase tracking-wider font-bold">Великий Алхімік</div>}
                                        </div>
                                        <div className={`font-mono font-black text-2xl ${i===0 ? 'text-yellow-400' : 'text-green-500'}`}>
                                            {p.score} VP
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <button onClick={leaveGame} className="w-full py-4 bg-green-800 hover:bg-green-700 text-white rounded-xl font-bold font-serif uppercase tracking-widest border-b-4 border-green-950 active:border-b-0 active:translate-y-1 transition-all">
                                Повернутися в меню
                            </button>
                        </div>
                    </div>
                );
            }

            // WAITING ROOM
            if (gameData.status === 'waiting') {
                return (
                    <div className="min-h-screen bg-[#0d1f14] flex flex-col items-center justify-center p-4">
                        <div className="bg-[#1a3c28] p-8 rounded-3xl border-4 border-yellow-600 text-center max-w-lg w-full shadow-2xl">
                            <h2 className="text-green-300 font-bold mb-2 uppercase tracking-wide text-xs">Код доступу</h2>
                            <div className="text-6xl font-mono font-black text-yellow-400 tracking-[0.15em] mb-8 bg-[#0d1f14] py-6 rounded-xl border border-green-800 select-all shadow-inner">
                                {gameId}
                            </div>
                            
                            <div className="space-y-3 mb-8 text-left">
                                {gameData.players.map((p, i) => (
                                    <div key={i} className="flex items-center gap-4 p-4 bg-[#0d1f14] border border-green-800 rounded-2xl shadow-lg">
                                        <div className="w-12 h-12 rounded-full bg-yellow-600 flex items-center justify-center font-serif font-bold text-black border-2 border-yellow-400">
                                            {p.name[0]}
                                        </div>
                                        <div className="font-bold text-xl text-green-100 font-serif">{p.name}</div>
                                        {i === 0 && <Crown className="ml-auto text-yellow-400 drop-shadow-md" />}
                                    </div>
                                ))}
                                {[...Array(4 - gameData.players.length)].map((_, i) => (
                                    <div key={i} className="p-4 border-2 border-dashed border-green-900 rounded-2xl flex items-center justify-center text-green-800 font-bold uppercase tracking-wider font-serif">
                                        Очікування...
                                    </div>
                                ))}
                            </div>

                            {isHost ? (
                                <button onClick={startGame} className="w-full py-4 bg-yellow-600 hover:bg-yellow-500 text-black rounded-xl font-black text-xl font-serif shadow-[0_0_20px_rgba(234,179,8,0.4)] transition-all active:scale-95">
                                    ПОЧАТИ ГРУ
                                </button>
                            ) : (
                                <div className="flex items-center justify-center gap-3 text-green-400 font-bold animate-pulse p-4">
                                    <Loader2 className="animate-spin"/> Очікування хоста...
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // MAIN GAME
            return (
                <div className="h-screen flex flex-col relative overflow-hidden">
                    
                    {/* HEADER */}
                    <header className="bg-[#0f291a] shadow-xl z-50 shrink-0 border-b border-green-800 px-4 py-2 flex justify-between items-center backdrop-blur-md">
                        <div className="flex items-center gap-2">
                            <span className="text-yellow-500 font-black font-serif text-lg tracking-widest hidden sm:inline">СИНТЕЗ</span>
                            <span className="text-[10px] bg-green-900 text-green-300 px-2 py-0.5 rounded border border-green-700 font-mono">
                                R: {Math.floor(gameData.turnIndex / gameData.players.length) + 1}
                            </span>
                        </div>
                        
                        <div className="flex overflow-x-auto gap-2 ml-2 scrollbar-hide flex-1 justify-end">
                            {gameData.players.map((p, i) => {
                                const active = gameData.turnIndex === i;
                                return (
                                    <div key={i} className={`flex items-center gap-2 px-3 py-1 rounded-lg border min-w-[100px] transition-all ${active ? 'bg-yellow-900/40 border-yellow-600 shadow-md' : 'bg-[#06120a] border-green-900 opacity-60'}`}>
                                        <div className={`w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-bold ${active ? 'bg-yellow-500 text-black' : 'bg-green-800 text-green-300'}`}>
                                            {p.name[0]}
                                        </div>
                                        <div className="flex flex-col leading-none">
                                            <div className={`font-bold text-xs mb-0.5 ${active ? 'text-yellow-100' : 'text-green-500'}`}>{p.name}</div>
                                            <div className="text-[10px] text-yellow-500 font-mono">{p.score} VP</div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        <button onClick={leaveGame} className="ml-2 text-green-600 hover:text-red-400 p-2 transition-colors">
                            <LogOut size={20}/>
                        </button>
                    </header>

                    {/* TARGETED TRADE ALERT (ONLY FOR TARGET) */}
                    {gameData.activeTrade && gameData.activeTrade.target === user.uid && (
                        <div className="absolute top-20 left-4 right-4 z-[60] animate-in slide-in-from-top duration-500 pointer-events-auto">
                            <div className="bg-[#f0fdf4] border-l-8 border-green-600 rounded-lg p-4 shadow-2xl flex flex-col gap-3 text-black max-w-lg mx-auto">
                                <div className="font-bold text-center text-sm font-serif">
                                    <span className="text-green-800 uppercase text-xs block mb-1 tracking-widest">🔥 ВХІДНА ПРОПОЗИЦІЯ</span>
                                    {gameData.players.find(p=>p.uid===gameData.activeTrade.initiator)?.name} пропонує:<br/>
                                    
                                    <div className="flex flex-wrap justify-center gap-1 my-2">
                                        {gameData.activeTrade.give.map((el,i) => (
                                            <span key={i} className="flex items-center gap-1 px-2 py-1 rounded-full text-white text-[10px] font-bold uppercase shadow-sm" style={{background: `var(--main-${el})`}}>
                                                {el}
                                            </span>
                                        ))}
                                    </div>
                                    за
                                    <div className="flex flex-wrap justify-center gap-1 my-2">
                                        {gameData.activeTrade.want.map((el,i) => (
                                            <span key={i} className="flex items-center gap-1 px-2 py-1 rounded-full text-white text-[10px] font-bold uppercase shadow-sm" style={{background: `var(--main-${el})`}}>
                                                {el}
                                            </span>
                                        ))}
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    {canIAcceptTrade(gameData.activeTrade) && (
                                        <button onClick={acceptActiveTrade} className="flex-1 bg-green-700 hover:bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg text-xs uppercase tracking-widest transition-colors">
                                            ПРИЙНЯТИ
                                        </button>
                                    )}
                                    <button onClick={rejectActiveTrade} className="flex-1 bg-red-700 hover:bg-red-600 text-white py-3 rounded-xl font-bold shadow-lg text-xs uppercase tracking-widest transition-colors">
                                        ВІДХИЛИТИ
                                    </button>
                                </div>
                                {!canIAcceptTrade(gameData.activeTrade) && <div className="text-center text-red-500 text-xs italic">У вас недостатньо ресурсів</div>}
                            </div>
                        </div>
                    )}

                    {/* MAIN AREA */}
                    <div className="flex-1 overflow-y-auto p-4 pb-60 scrollbar-hide relative pt-32 sm:pt-4">
                        
                        {/* MOBILE LOGS */}
                        <div className="
                            fixed top-[70px] left-2 right-2 h-20 
                            sm:top-auto sm:bottom-[240px] sm:left-auto sm:right-4 sm:w-64 sm:h-40
                            bg-[#06120a]/80 border border-green-800 rounded-lg p-2 overflow-y-auto shadow-lg backdrop-blur text-[10px] z-30
                        ">
                            <div className="text-green-500 font-bold uppercase mb-1 px-1 sticky top-0 bg-[#06120a]/90 w-full">Хроніки лабораторії</div>
                            {gameData.logs.slice().reverse().map((log, i) => (
                                <div key={i} className="mb-1 text-green-300 font-serif border-b border-green-900/50 pb-1 pl-1">
                                    <span className="opacity-50 mr-2">{new Date(log.time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>
                                    {log.text}
                                </div>
                            ))}
                        </div>

                        {/* MARKET */}
                        <div className="flex flex-wrap gap-4 justify-center pb-20 mt-4 sm:mt-0">
                            {gameData.market.map(mol => (
                                <MoleculeCard 
                                    key={mol.uniqueId} 
                                    mol={mol} 
                                    canBuy={isMyTurn && turnPhase === 'action' && checkRecipe(myPlayer.hand, mol.req)} 
                                    onBuy={synthesizeMolecule}
                                />
                            ))}
                            {gameData.market.length === 0 && (
                                <div className="text-green-600 italic border border-green-800 px-8 py-4 rounded-xl">
                                    Ринок порожній...
                                </div>
                            )}
                        </div>
                    </div>

                    {/* NOTIFICATIONS */}
                    {notification && (
                        <div className={`
                            fixed bottom-1/2 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl shadow-2xl text-white font-bold z-[100] 
                            border-2 font-serif animate-in slide-in-from-bottom-4 flex items-center gap-3
                            ${notification.type === 'error' ? 'bg-red-900 border-red-500' : 'bg-green-800 border-green-500'}
                        `}>
                            {notification.type === 'error' ? <X size={18}/> : <CheckCircle2 size={18}/>}
                            {notification.msg}
                        </div>
                    )}

                    {/* BOTTOM PANEL */}
                    <div className="absolute bottom-0 left-0 w-full z-40 flex flex-col justify-end pointer-events-none">
                        
                        {/* ACTIONS */}
                        <div className="flex justify-center mb-4 px-4 gap-3 pointer-events-auto">
                            {isMyTurn && (
                                <>
                                    {turnPhase === 'draw' && (
                                        <button onClick={drawCards} className="bg-yellow-600 hover:bg-yellow-500 text-black px-6 py-3 rounded-full font-black shadow-[0_0_20px_rgba(234,179,8,0.4)] animate-bounce font-serif tracking-widest text-sm border-2 border-yellow-400 flex items-center gap-2">
                                            <History size={16}/> ДОСЛІДИТИ (+2)
                                        </button>
                                    )}
                                    
                                    {turnPhase === 'action' && (
                                        <div className="flex gap-2 bg-[#06120a]/90 backdrop-blur p-2 rounded-full border border-green-600 shadow-xl">
                                            <button 
                                                onClick={openTradeModal} 
                                                className="bg-purple-800 text-purple-100 px-5 py-2 rounded-full font-bold text-xs uppercase hover:bg-purple-700 flex items-center gap-2 transition-colors"
                                            >
                                                <RefreshCcw size={16}/> ОБМІН
                                            </button>
                                            <button 
                                                onClick={endTurn} 
                                                className="bg-green-800 text-green-100 px-5 py-2 rounded-full font-bold text-xs uppercase hover:bg-green-700 border border-green-600 transition-colors"
                                            >
                                                ЗАВЕРШИТИ
                                            </button>
                                        </div>
                                    )}

                                    {isDiscardPhase && (
                                        <button onClick={discardCards} className="bg-red-700 text-white px-6 py-3 rounded-full font-bold animate-pulse text-xs uppercase border-2 border-red-500 flex items-center gap-2 shadow-lg">
                                            <Trash2 size={16}/> СКИНУТИ {cardsToDiscard - selectedCards.length}
                                        </button>
                                    )}
                                </>
                            )}
                            
                            {/* CANCEL OFFER BUTTON */}
                            {gameData.activeTrade && gameData.activeTrade.initiator === user.uid && (
                                <button onClick={rejectActiveTrade} className="bg-gray-600 text-white px-6 py-3 rounded-full font-bold text-xs shadow-lg flex items-center gap-2 hover:bg-gray-500 transition-colors">
                                    <X size={16}/> СКАСУВАТИ ОБМІН
                                </button>
                            )}
                        </div>

                        {/* HAND */}
                        <div className="bg-[#1a3c28] w-full rounded-t-[2.5rem] shadow-[0_-10px_40px_rgba(0,0,0,0.6)] pt-3 pb-8 px-2 relative pointer-events-auto border-t-4 border-yellow-600 transition-transform hover:translate-y-0 translate-y-2">
                            <div className="w-16 h-1.5 bg-green-700 rounded-full mx-auto mb-3"></div>
                            <div className="text-center text-[10px] text-green-400 font-black uppercase tracking-widest mb-1">
                                ВАШ ІНВЕНТАР ({myPlayer?.hand.length})
                            </div>
                            
                            <div className="overflow-x-auto overflow-y-visible flex justify-center px-4 py-4 min-h-[170px] scrollbar-hide pb-10">
                                <div className="flex -space-x-10 sm:-space-x-6 px-8 items-end">
                                    {myPlayer?.hand
                                        .map((card, idx) => ({ card, idx }))
                                        .sort((a, b) => a.card.localeCompare(b.card))
                                        .map(({ card, idx }, i, arr) => {
                                            const isSelected = selectedCards.includes(idx);
                                            const rotation = (i - (arr.length - 1) / 2) * 4; 
                                            const translateY = Math.abs(i - (arr.length - 1) / 2) * 3;

                                            return (
                                                <div 
                                                    key={idx} 
                                                    className="relative transition-all duration-300 origin-bottom" 
                                                    style={{ 
                                                        zIndex: isSelected ? 50 : i, 
                                                        transform: `rotate(${rotation}deg) translateY(${translateY}px)` 
                                                    }}
                                                >
                                                    <ElementCard 
                                                        type={card} 
                                                        selected={isSelected} 
                                                        onClick={() => {
                                                            if(isMyTurn && (turnPhase==='discard_force'||turnPhase==='action')) {
                                                                setSelectedCards(p => p.includes(idx) ? p.filter(x => x!==idx) : [...p, idx]);
                                                            }
                                                        }}
                                                    />
                                                </div>
                                            );
                                        })
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* TRADE MODAL */}
                    <Modal isOpen={isTradeModalOpen} onClose={() => setTradeModalOpen(false)} title="Торгова Гільдія">
                        <div className="flex mb-4 bg-green-100 p-1 rounded-xl">
                            <button 
                                onClick={() => {setTradeTab('bank'); setTradeWant([]); setTradeTargetPlayer(null);}} 
                                className={`flex-1 py-3 rounded-lg font-bold text-xs uppercase transition-all flex flex-col items-center ${tradeTab==='bank' ? 'bg-yellow-600 text-white shadow' : 'text-green-800 hover:bg-green-200'}`}
                            >
                                <span className="text-sm">Банк</span>
                                <span className="opacity-70 text-[10px]">Курс 3:1</span>
                            </button>
                            <button 
                                onClick={() => {setTradeTab('player'); setTradeWant([]);}} 
                                className={`flex-1 py-3 rounded-lg font-bold text-xs uppercase transition-all flex flex-col items-center ${tradeTab==='player' ? 'bg-purple-700 text-white shadow' : 'text-green-800 hover:bg-green-200'}`}
                            >
                                <span className="text-sm">Приватний обмін</span>
                                <span className="opacity-70 text-[10px]">Вільний курс</span>
                            </button>
                        </div>

                        {/* STEP 1: GIVING */}
                        <div className="mb-4">
                            <h4 className="text-[10px] font-bold text-green-800 uppercase mb-2 flex justify-between">
                                <span>1. Ви віддаєте:</span>
                                <span className="text-green-600">{selectedCards.length} шт.</span>
                            </h4>
                            <div className="flex gap-2 min-h-[60px] p-2 bg-white border border-green-300 rounded-lg overflow-x-auto items-center">
                                {selectedCards.length > 0 ? selectedCards.map(idx => (
                                    <div key={idx} className="flex flex-col items-center justify-center w-10 h-12 rounded shadow-sm shrink-0" style={{background: `var(--bg-${myPlayer.hand[idx]})`, color: `var(--main-${myPlayer.hand[idx]})`}}>
                                        <span className="font-serif font-bold text-sm">{myPlayer.hand[idx]}</span>
                                    </div>
                                )) : <span className="text-xs text-gray-400 italic mx-auto">Оберіть карти в руці (знизу)</span>}
                            </div>
                        </div>

                        <div className="flex justify-center my-2 text-gray-300"><ArrowRightLeft size={20}/></div>

                        {/* STEP 2: SELECT PARTNER (ONLY FOR PLAYER TRADE) */}
                        {tradeTab === 'player' && (
                            <div className="mb-4">
                                <h4 className="text-[10px] font-bold text-green-800 uppercase mb-2">2. Оберіть партнера:</h4>
                                <div className="flex flex-wrap gap-2">
                                    {gameData.players.filter(p => p.uid !== user.uid).map(p => (
                                        <button 
                                            key={p.uid} 
                                            onClick={() => selectTradeTarget(p.uid)}
                                            className={`
                                                px-3 py-2 rounded-lg text-xs font-bold border transition-all
                                                ${tradeTargetPlayer === p.uid 
                                                    ? 'bg-purple-600 text-white border-purple-800 ring-2 ring-purple-300' 
                                                    : 'bg-white text-green-800 border-green-300 hover:bg-green-50'}
                                            `}
                                        >
                                            {p.name}
                                        </button>
                                    ))}
                                    {gameData.players.length < 2 && <span className="text-xs text-gray-400 italic">Немає інших гравців...</span>}
                                </div>
                            </div>
                        )}

                        {/* STEP 3: SELECT WANTED */}
                        <div className="mb-6">
                            <h4 className="text-[10px] font-bold text-green-800 uppercase mb-2 flex justify-between">
                                <span>{tradeTab === 'player' ? '3' : '2'}. Ви хочете отримати:</span>
                                <span className="text-green-600">{tradeWant.length} шт.</span>
                            </h4>
                            
                            {tradeWant.length > 0 && (
                                <div className="flex flex-wrap gap-2 mb-3 p-2 bg-gray-50 border border-gray-200 rounded-lg min-h-[40px]">
                                    {tradeWant.map((el, i) => (
                                        <div 
                                            key={i} 
                                            onClick={() => removeFromTradeWant(i)}
                                            className="cursor-pointer flex items-center gap-1 px-2 py-1 rounded shadow-sm hover:opacity-80 shrink-0" 
                                            style={{background: `var(--main-${el})`, color: 'white'}}
                                        >
                                            <span className="text-xs font-bold">{el}</span>
                                            <X size={10}/>
                                        </div>
                                    ))}
                                </div>
                            )}

                            <div className="grid grid-cols-5 gap-2">
                                {Object.keys(ELEMENTS).map(el => (
                                    <button 
                                        key={el} 
                                        onClick={() => { if (tradeTab === 'bank') setTradeWant([el]); else addToTradeWant(el); }} 
                                        className="p-1 rounded-lg border text-[10px] font-bold bg-white text-green-900 hover:bg-green-100 flex flex-col items-center transition-colors h-10 justify-center shadow-sm"
                                    >
                                        <span className="text-xs">{el}</span>
                                    </button>
                                ))}
                            </div>
                        </div>

                        <button 
                            onClick={tradeTab === 'bank' ? executeBankTrade : createPlayerTrade} 
                            disabled={tradeTab === 'bank' ? (selectedCards.length !== 3 || tradeWant.length !== 1) : (selectedCards.length === 0 || tradeWant.length === 0 || !tradeTargetPlayer)}
                            className={`
                                w-full py-3 rounded-xl font-bold uppercase text-xs tracking-widest shadow-md transition-all flex justify-between px-4
                                ${((tradeTab==='bank' && selectedCards.length===3 && tradeWant.length===1) || (tradeTab==='player' && selectedCards.length>0 && tradeWant.length>0 && tradeTargetPlayer)) 
                                    ? (tradeTab === 'bank' ? 'bg-yellow-600 text-white hover:bg-yellow-500' : 'bg-purple-700 text-white hover:bg-purple-600') 
                                    : 'bg-gray-200 text-gray-400 cursor-not-allowed'}
                            `}
                        >
                            <span>{tradeTab === 'bank' ? 'Обмін з Банком' : 'Надіслати пропозицію'}</span>
                        </button>
                    </Modal>

                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<SynthesisGame />);
    </script>
</body>
</html>
