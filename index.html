<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–°–ò–ù–¢–ï–ó - Alchemy Ultimate</title>
    
    <!-- –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ React —Ç–∞ Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts (–¥–ª—è –∞–ª—Ö—ñ–º—ñ—á–Ω–æ–≥–æ –≤–∏–≥–ª—è–¥—É) -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Lato:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- –ë–ê–ó–û–í–Ü –°–¢–ò–õ–Ü --- */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        body {
            font-family: 'Lato', sans-serif;
            background-color: #022c22; /* –î—É–∂–µ —Ç–µ–º–Ω–∏–π –∑–µ–ª–µ–Ω–∏–π —Ñ–æ–Ω */
            background-image: radial-gradient(#064e3b 1px, transparent 1px);
            background-size: 20px 20px;
            color: #ecfdf5;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        h1, h2, h3, .font-serif {
            font-family: 'Cinzel', serif;
        }

        /* --- –ó–û–õ–û–¢–Ü –ï–§–ï–ö–¢–ò --- */
        .text-gold {
            background: linear-gradient(to bottom, #fde047, #d97706);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0px 2px 4px rgba(0,0,0,0.3);
        }
        
        .border-gold {
            border-color: #d97706;
            box-shadow: 0 0 10px rgba(217, 119, 6, 0.3);
        }

        .bg-gold-gradient {
            background: linear-gradient(135deg, #a16207 0%, #facc15 50%, #a16207 100%);
        }

        /* --- –ê–ù–Ü–ú–ê–¶–Ü–á --- */
        @keyframes shine {
            0% { background-position: -100% 50%; }
            100% { background-position: 200% 50%; }
        }
        
        .animate-shine {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            background-size: 200% 100%;
            animation: shine 2s infinite;
        }

        /* –°—Ç–∏–ª—å –ø–æ–º–∏–ª–æ–∫ */
        #error-overlay {
            display: none; position: fixed; inset: 0; background: white; z-index: 9999; padding: 20px; color: red;
        }
    </style>
</head>
<body>
    <div id="error-overlay">
        <h2 class="text-xl font-bold mb-2">‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞:</h2>
        <pre id="error-msg" class="whitespace-pre-wrap font-mono text-xs"></pre>
        <button onclick="window.location.reload()" class="mt-4 bg-green-700 text-white px-4 py-2 rounded">–ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≥—Ä—É</button>
    </div>
    
    <div id="root"></div>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            document.getElementById('error-overlay').style.display = 'block';
            document.getElementById('error-msg').innerText = `${msg}\nLocation: ${line}:${col}\n${error?.stack}`;
        };
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, 
            arrayUnion, runTransaction, increment 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { 
            getAuth, signInAnonymously, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        
        // Icons
        import { 
            Atom, FlaskConical, ArrowRightLeft, Crown, LogOut, Loader2, X, 
            History, Trash2, RefreshCcw, CheckCircle2, ShieldCheck, Scroll
        } from 'https://esm.sh/lucide-react@0.263.1';

        // --- –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAEownlzJ0AqrnAku7Cw208N2DRLQHdD6Y",
            authDomain: "synthesis-game-f9684.firebaseapp.com",
            projectId: "synthesis-game-f9684",
            storageBucket: "synthesis-game-f9684.firebasestorage.app",
            messagingSenderId: "257683012244",
            appId: "1:257683012244:web:c7aee7e27c929ceb5b9281"
        };

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase init error", e);
        }

        const appId = 'synthesis-game';
        const WINNING_SCORE = 50;

        // --- –î–û–í–Ü–î–ù–ò–ö –ï–õ–ï–ú–ï–ù–¢–Ü–í ---
        const ELEMENTS = {
            'H':  { m: 1.008, name: '–ì—ñ–¥—Ä–æ–≥–µ–Ω', color: 'bg-slate-50 border-blue-200 text-blue-900 ring-blue-400' },
            'O':  { m: 15.99, name: '–û–∫—Å–∏–≥–µ–Ω',  color: 'bg-slate-50 border-red-200 text-red-900 ring-red-400' },
            'C':  { m: 12.01, name: '–ö–∞—Ä–±–æ–Ω',   color: 'bg-slate-100 border-gray-400 text-gray-900 ring-gray-400' },
            'N':  { m: 14.00, name: '–ù—ñ—Ç—Ä–æ–≥–µ–Ω', color: 'bg-slate-50 border-indigo-200 text-indigo-900 ring-indigo-400' },
            'Na': { m: 22.99, name: '–ù–∞—Ç—Ä—ñ–π',   color: 'bg-slate-50 border-purple-200 text-purple-900 ring-purple-400' },
            'Cl': { m: 35.45, name: '–•–ª–æ—Ä',   color: 'bg-slate-50 border-emerald-200 text-emerald-900 ring-emerald-400' },
            'Ca': { m: 40.08, name: '–ö–∞–ª—å—Ü—ñ–π',  color: 'bg-slate-50 border-orange-200 text-orange-900 ring-orange-400' },
            'S':  { m: 32.06, name: '–°—É–ª—å—Ñ—É—Ä',  color: 'bg-slate-50 border-yellow-300 text-yellow-900 ring-yellow-400' },
            'Si': { m: 28.08, name: '–°–∏–ª—ñ—Ü—ñ–π',  color: 'bg-slate-50 border-stone-300 text-stone-800 ring-stone-400' },
        };

        const ELEMENT_DISTRIBUTION = {
            'H': 24, 'O': 34, 'C': 12, 'Na': 10, 'Cl': 7, 'Ca': 8, 'N': 7, 'S': 6, 'Si': 4
        };

        const MOLECULES_LIST = [
            // –ü—Ä–æ—Å—Ç—ñ
            { id: 'h2o',     f: 'H‚ÇÇO',      name: '–í–æ–¥–∞',              vp: 3, count: 6, req: { 'H': 2, 'O': 1 } },
            { id: 'co',      f: 'CO',       name: '–ß–∞–¥–Ω–∏–π –≥–∞–∑',        vp: 4, count: 4, req: { 'C': 1, 'O': 1 } },
            { id: 'hcl',     f: 'HCl',      name: '–•–ª–æ—Ä–∏–¥–Ω–∞ –∫–∏—Å–ª–æ—Ç–∞',  vp: 6, count: 3, req: { 'H': 1, 'Cl': 1 } },
            { id: 'cao',     f: 'CaO',      name: '–ù–µ–≥–∞—à–µ–Ω–µ –≤–∞–ø–Ω–æ',    vp: 4, count: 3, req: { 'Ca': 1, 'O': 1 } },
            // –°–µ—Ä–µ–¥–Ω—ñ
            { id: 'co2',     f: 'CO‚ÇÇ',      name: '–í—É–≥–ª–µ–∫–∏—Å–ª–∏–π –≥–∞–∑',   vp: 5, count: 5, req: { 'C': 1, 'O': 2 } },
            { id: 'nacl',    f: 'NaCl',     name: '–ö—É—Ö–æ–Ω–Ω–∞ —Å—ñ–ª—å',      vp: 8, count: 4, req: { 'Na': 1, 'Cl': 1 } },
            { id: 'naoh',    f: 'NaOH',     name: '–ö–∞—É—Å—Ç–∏—á–Ω–∞ —Å–æ–¥–∞',    vp: 5, count: 3, req: { 'Na': 1, 'O': 1, 'H': 1 } },
            { id: 'nh3',     f: 'NH‚ÇÉ',      name: '–ê–º—ñ–∞–∫',             vp: 8, count: 2, req: { 'N': 1, 'H': 3 } },
            { id: 'h2o2',    f: 'H‚ÇÇO‚ÇÇ',     name: '–ü–µ—Ä–µ–∫–∏—Å –≤–æ–¥–Ω—é',     vp: 4, count: 2, req: { 'H': 2, 'O': 2 } },
            { id: 'so2',     f: 'SO‚ÇÇ',      name: '–°—ñ—Ä—á–∏—Å—Ç–∏–π –≥–∞–∑',     vp: 4, count: 2, req: { 'S': 1, 'O': 2 } },
            { id: 'sio2',    f: 'SiO‚ÇÇ',     name: '–ü—ñ—Å–æ–∫',             vp: 10, count: 2, req: { 'Si': 1, 'O': 2 } },
            // –°–∫–ª–∞–¥–Ω—ñ (High VP)
            { id: 'caoh2',   f: 'Ca(OH)‚ÇÇ',  name: '–ì–∞—à–µ–Ω–µ –≤–∞–ø–Ω–æ',      vp: 7, count: 2, req: { 'Ca': 1, 'O': 2, 'H': 2 } },
            { id: 'h2so4',   f: 'H‚ÇÇSO‚ÇÑ',    name: '–°—É–ª—å—Ñ–∞—Ç–Ω–∞ –∫–∏—Å–ª–æ—Ç–∞', vp: 12, count: 1, req: { 'H': 2, 'S': 1, 'O': 4 } },
            { id: 'caco3',   f: 'CaCO‚ÇÉ',    name: '–ö—Ä–µ–π–¥–∞',            vp: 9, count: 3, req: { 'Ca': 1, 'C': 1, 'O': 3 } },
            { id: 'nahco3',  f: 'NaHCO‚ÇÉ',   name: '–•–∞—Ä—á–æ–≤–∞ —Å–æ–¥–∞',      vp: 10, count: 3, req: { 'Na': 1, 'H': 1, 'C': 1, 'O': 3 } },
            { id: 'na2co3',  f: 'Na‚ÇÇCO‚ÇÉ',   name: '–ö–∞–ª—å—Ü–∏–Ω–æ–≤–∞–Ω–∞ —Å–æ–¥–∞', vp: 12, count: 3, req: { 'Na': 2, 'C': 1, 'O': 3 } },
        ];

        // --- –õ–û–ì–Ü–ö–ê –¢–ê –£–¢–ò–õ–Ü–¢–ò ---

        const shuffleArray = (array) => {
            let arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        };

        const generateElementDeck = () => {
            let deck = [];
            Object.entries(ELEMENT_DISTRIBUTION).forEach(([el, count]) => {
                for (let i = 0; i < count; i++) deck.push(el);
            });
            return shuffleArray(deck);
        };

        const generateMoleculeDeck = () => {
            let deck = [];
            MOLECULES_LIST.forEach(mol => {
                for (let i = 0; i < (mol.count || 1); i++) {
                    deck.push({ ...mol, uniqueId: `${mol.id}_${Math.random().toString(36).substr(2, 8)}` });
                }
            });
            return shuffleArray(deck);
        };

        const checkRecipe = (hand, recipe) => {
            const handCounts = {};
            hand.forEach(el => handCounts[el] = (handCounts[el] || 0) + 1);
            
            for (const [el, needed] of Object.entries(recipe)) {
                if (!handCounts[el] || handCounts[el] < needed) return false;
            }
            return true;
        };

        const getAtomsList = (req) => {
            let list = [];
            Object.entries(req).forEach(([el, count]) => {
                for(let i=0; i<count; i++) list.push(el);
            });
            return list;
        };

        // --- –ö–û–ú–ü–û–ù–ï–ù–¢–ò –Ü–ù–¢–ï–†–§–ï–ô–°–£ ---

        // 1. –ö–∞—Ä—Ç–∫–∞ –ï–ª–µ–º–µ–Ω—Ç–∞ (–ü–æ–≤–Ω–∏–π –¥–∏–∑–∞–π–Ω)
        const ElementCard = ({ type, onClick, selected = false, style, overlap = false, mini = false }) => {
            const data = ELEMENTS[type] || { m: '?', name: type, color: 'bg-gray-300' };

            // –ú—ñ–Ω—ñ-–≤–µ—Ä—Å—ñ—è –¥–ª—è –º–æ–¥–∞–ª—å–Ω–∏—Ö –≤—ñ–∫–æ–Ω
            if (mini) {
                return (
                    <div 
                        onClick={onClick} 
                        className={`
                            relative w-12 h-16 rounded border-2 shadow-sm flex flex-col items-center justify-center cursor-pointer transition-transform
                            ${data.color} 
                            ${selected ? 'ring-2 ring-yellow-500 scale-110 z-10' : 'hover:scale-105'}
                        `}
                    >
                        <span className="font-bold text-lg font-serif">{type}</span>
                    </div>
                );
            }

            // –ü–æ–≤–Ω–∞ –≤–µ—Ä—Å—ñ—è –¥–ª—è —Ä—É–∫–∏
            return (
                <div 
                    onClick={onClick}
                    style={style}
                    className={`
                        relative w-24 h-36 rounded-xl border-2 flex flex-col justify-between p-2 select-none transition-all duration-300 flex-shrink-0 bg-white shadow-xl
                        ${data.color}
                        ${selected ? '-translate-y-8 z-30 ring-4 ring-yellow-400 border-yellow-500 shadow-yellow-500/50' : 'hover:-translate-y-4 hover:z-20 shadow-black/20'}
                        ${overlap ? '-ml-12 hover:ml-0' : ''}
                        cursor-pointer
                    `}
                >
                    {/* –í–µ—Ä—Ö–Ω—ñ–π —ñ–Ω–¥–µ–∫—Å */}
                    <div className="flex justify-between items-start font-bold leading-none z-10">
                        <span className="text-lg font-serif">{type}</span>
                        <span className="text-[10px] opacity-60 pt-1">{data.m}</span>
                    </div>

                    {/* –¶–µ–Ω—Ç—Ä */}
                    <div className="flex flex-col items-center justify-center flex-grow z-10">
                        <span className="text-5xl font-black font-serif opacity-90 tracking-tighter">{type}</span>
                        <span className="text-[0.6rem] uppercase tracking-wider opacity-70 mt-2 truncate w-full text-center font-bold border-t border-current pt-1">{data.name}</span>
                    </div>

                    {/* –ù–∏–∂–Ω—ñ–π —ñ–Ω–¥–µ–∫—Å (–ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∏–π) */}
                    <div className="flex justify-between items-end font-bold leading-none rotate-180 z-10">
                        <span className="text-lg font-serif">{type}</span>
                        <span className="text-[10px] opacity-60 pb-1">{data.m}</span>
                    </div>
                </div>
            );
        };

        // 2. –ö–∞—Ä—Ç–∫–∞ –ú–æ–ª–µ–∫—É–ª–∏ (–ü–æ–≤–Ω–∏–π –¥–∏–∑–∞–π–Ω)
        const MoleculeCard = ({ mol, canBuy, onBuy }) => {
            const atoms = getAtomsList(mol.req);
            return (
                <div 
                    onClick={() => canBuy && onBuy(mol)}
                    className={`
                        relative w-[45%] sm:w-44 min-h-[190px] bg-[#fdfdfd] rounded-xl border-4 shadow-lg flex flex-col overflow-hidden transition-all duration-300
                        ${canBuy ? 'border-yellow-400 scale-105 cursor-pointer z-10 shadow-yellow-500/40' : 'border-emerald-900/80 opacity-95'}
                    `}
                >
                    {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */}
                    <div className="bg-emerald-900 text-yellow-50 px-3 py-2 flex justify-between items-center border-b border-emerald-800">
                        <span className="text-[10px] uppercase font-bold tracking-widest truncate max-w-[70%]">{mol.name}</span>
                        <span className="bg-yellow-600 text-white text-xs font-bold px-2 py-0.5 rounded shadow-inner">{mol.vp} VP</span>
                    </div>

                    {/* –¢—ñ–ª–æ –∫–∞—Ä—Ç–∫–∏ */}
                    <div className="p-3 flex flex-col items-center flex-grow justify-center relative bg-[url('https://www.transparenttextures.com/patterns/graphy.png')]">
                        <div className="text-3xl font-black font-serif text-emerald-950 z-10 leading-tight drop-shadow-sm">{mol.f}</div>
                        
                        {/* –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –∞—Ç–æ–º—ñ–≤ */}
                        <div className="mt-4 flex flex-wrap justify-center gap-1.5 z-10 max-w-full">
                            {atoms.map((el, i) => (
                                <div key={i} className={`
                                    w-6 h-6 rounded-full border border-black/20 shadow-md flex items-center justify-center text-[0.65rem] font-bold
                                    ${ELEMENTS[el]?.color || 'bg-gray-200'}
                                `}>
                                    {el}
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* –ö–Ω–æ–ø–∫–∞ —Å–∏–Ω—Ç–µ–∑—É (–∑'—è–≤–ª—è—î—Ç—å—Å—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ –∞–±–æ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ) */}
                    {canBuy && (
                        <div className="absolute inset-0 bg-yellow-500/10 flex items-center justify-center backdrop-blur-[1px]">
                            <div className="bg-yellow-500 text-black px-4 py-2 rounded-full shadow-xl font-black text-sm uppercase tracking-widest flex items-center gap-2 animate-bounce border-2 border-yellow-300">
                                <FlaskConical size={16}/> –°–∏–Ω—Ç–µ–∑
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 3. –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ (–£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–µ)
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="bg-[#fcfcfc] rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden border-2 border-emerald-600">
                        <div className="bg-emerald-900 px-6 py-4 border-b border-emerald-800 flex justify-between items-center">
                            <h3 className="text-xl font-bold text-yellow-50 font-serif">{title}</h3>
                            <button onClick={onClose} className="p-2 hover:bg-emerald-800 rounded-full text-emerald-200 transition-colors">
                                <X size={24}/>
                            </button>
                        </div>
                        <div className="p-6 bg-[#f0fdf4]">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // --- –ì–û–õ–û–í–ù–ò–ô –ö–õ–ê–° –ì–†–ò ---

        const SynthesisGame = () => {
            // –°—Ç–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó —Ç–∞ –∫—ñ–º–Ω–∞—Ç–∏
            const [user, setUser] = useState(null);
            const [gameId, setGameId] = useState(localStorage.getItem('lastGameId') || '');
            const [gameData, setGameData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [playerName, setPlayerName] = useState(localStorage.getItem('playerName') || '');
            
            // –°—Ç–∞–Ω —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
            const [selectedCards, setSelectedCards] = useState([]); // –Ü–Ω–¥–µ–∫—Å–∏ –∫–∞—Ä—Ç –≤ —Ä—É—Ü—ñ
            const [notification, setNotification] = useState(null);
            const [targetGameId, setTargetGameId] = useState('');
            
            // –°—Ç–∞–Ω —Ç–æ—Ä–≥—ñ–≤–ª—ñ
            const [isTradeModalOpen, setTradeModalOpen] = useState(false);
            const [tradeTab, setTradeTab] = useState('bank'); // 'bank' | 'player'
            const [tradeOffer, setTradeOffer] = useState({ give: [], want: '' });

            // 1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Auth Error:", error);
                        showNotification('error', "–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É –≤ —Å–∏—Å—Ç–µ–º—É");
                    }
                };
                initAuth();
                return onAuthStateChanged(auth, (u) => setUser(u));
            }, []);

            // 2. –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∑ –ë–î
            useEffect(() => {
                if (!gameId || !db) return;
                
                const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
                const unsubscribe = onSnapshot(gameRef, (snap) => {
                    if (snap.exists()) {
                        setGameData(snap.data());
                    } else {
                        setGameData(null);
                        if (gameId) showNotification('error', '–ö—ñ–º–Ω–∞—Ç—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
                        setGameId('');
                    }
                }, (error) => {
                    console.error("Sync Error:", error);
                    showNotification('error', '–í—Ç—Ä–∞—á–µ–Ω–æ –∑–≤\'—è–∑–æ–∫ –∑ —Å–µ—Ä–≤–µ—Ä–æ–º');
                });

                return () => unsubscribe();
            }, [gameId]);

            // --- –î–æ–ø–æ–º—ñ–∂–Ω—ñ –∑–º—ñ–Ω–Ω—ñ ---
            const myIndex = gameData?.players.findIndex(p => p.uid === user?.uid) ?? -1;
            const myPlayer = myIndex !== -1 ? gameData.players[myIndex] : null;
            const isMyTurn = gameData?.status === 'playing' && gameData?.turnIndex === myIndex;
            const isHost = gameData?.players[0].uid === user?.uid;
            
            const turnPhase = gameData?.turnPhase; // 'draw', 'action', 'discard_force'
            const isDiscardPhase = turnPhase === 'discard_force' && isMyTurn;
            const cardsToDiscard = isDiscardPhase && myPlayer ? Math.max(0, myPlayer.hand.length - 10) : 0;

            // --- –§—É–Ω–∫—Ü—ñ—ó —Å–ø–æ–≤—ñ—â–µ–Ω—å ---
            const showNotification = (type, msg) => {
                setNotification({ type, msg });
                setTimeout(() => setNotification(null), 3000);
            };

            // --- –Ü–≥—Ä–æ–≤—ñ –î—ñ—ó ---

            const createGame = async () => {
                if (!playerName.trim()) return showNotification('error', "–í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ —ñ–º'—è!");
                setLoading(true);
                
                localStorage.setItem('playerName', playerName);
                const newGameId = Math.random().toString(36).substring(2, 6).toUpperCase();
                
                const molDeck = generateMoleculeDeck();
                const initialMarket = molDeck.splice(0, 4); 

                const initialData = {
                    id: newGameId,
                    status: 'waiting', 
                    players: [{
                        uid: user.uid,
                        name: playerName,
                        hand: [],
                        score: 0,
                        molecules: [] // ids of molecules
                    }],
                    elementDeck: generateElementDeck(),
                    moleculeDeck: molDeck,
                    market: initialMarket,
                    discardPile: [], 
                    turnIndex: 0,
                    turnPhase: 'draw', 
                    activeTrade: null,
                    logs: [{ text: `–ê–ª—Ö—ñ–º—ñ–∫ ${playerName} –≤—ñ–¥–∫—Ä–∏–≤ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—é`, time: Date.now() }]
                };

                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', newGameId), initialData);
                    setGameId(newGameId);
                    localStorage.setItem('lastGameId', newGameId);
                } catch (e) {
                    showNotification('error', '–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –≥—Ä–∏');
                }
                setLoading(false);
            };

            const joinGame = async (code) => {
                if (!playerName.trim()) return showNotification('error', "–í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ —ñ–º'—è!");
                setLoading(true);
                localStorage.setItem('playerName', playerName);

                const codeUpper = code.toUpperCase().trim();
                const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', codeUpper);

                try {
                    await runTransaction(db, async (transaction) => {
                        const sfDoc = await transaction.get(gameRef);
                        if (!sfDoc.exists()) throw "–ö—ñ–º–Ω–∞—Ç–∏ –Ω–µ —ñ—Å–Ω—É—î";
                        
                        const data = sfDoc.data();
                        if (data.status !== 'waiting') throw "–ì—Ä–∞ –≤–∂–µ –ø–æ—á–∞–ª–∞—Å—å";
                        if (data.players.length >= 4) throw "–ö—ñ–º–Ω–∞—Ç–∞ –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–∞";
                        if (data.players.some(p => p.uid === user.uid)) return; // –í–∂–µ –≤ –≥—Ä—ñ

                        const newPlayer = { uid: user.uid, name: playerName, hand: [], score: 0, molecules: [] };
                        transaction.update(gameRef, {
                            players: arrayUnion(newPlayer),
                            logs: arrayUnion({ text: `${playerName} –ø—Ä–∏—î–¥–Ω–∞–≤—Å—è –¥–æ –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—É`, time: Date.now() })
                        });
                    });
                    setGameId(codeUpper);
                    localStorage.setItem('lastGameId', codeUpper);
                } catch (e) {
                    showNotification('error', typeof e === 'string' ? e : e.message);
                }
                setLoading(false);
            };

            const startGame = async () => {
                const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
                const newDeck = [...gameData.elementDeck];
                
                // –†–æ–∑–¥–∞—á–∞ –ø–æ 5 –∫–∞—Ä—Ç
                const updatedPlayers = gameData.players.map(p => ({ 
                    ...p, 
                    hand: newDeck.splice(0, 5) 
                }));

                await updateDoc(gameRef, {
                    status: 'playing', 
                    elementDeck: newDeck, 
                    players: updatedPlayers, 
                    turnPhase: 'draw',
                    logs: arrayUnion({ text: '–ï–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –ø–æ—á–∞–≤—Å—è! –†–æ–∑–¥–∞–Ω–æ –ø–æ 5 –µ–ª–µ–º–µ–Ω—Ç—ñ–≤.', time: Date.now() })
                });
            };

            const drawCards = async () => {
                if (!isMyTurn || turnPhase !== 'draw') return;
                
                let newDeck = [...gameData.elementDeck];
                if (newDeck.length < 2) {
                     showNotification('error', '–ö–æ–ª–æ–¥–∞ –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ –≤–∏—á–µ—Ä–ø–∞–Ω–∞!'); 
                     // –¢—É—Ç –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –ª–æ–≥—ñ–∫—É –ø–µ—Ä–µ—Ç–∞—Å–æ–≤–∫–∏ —Å–∫–∏–¥—É
                     return; 
                }

                const drawn = newDeck.splice(0, 2);
                const updatedPlayers = [...gameData.players];
                const newHand = [...myPlayer.hand, ...drawn];
                updatedPlayers[myIndex].hand = newHand;
                
                const nextPhase = newHand.length > 10 ? 'discard_force' : 'action';

                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                    elementDeck: newDeck,
                    players: updatedPlayers,
                    turnPhase: nextPhase,
                    logs: arrayUnion({ text: `${myPlayer.name} –æ—Ç—Ä–∏–º–∞–≤ –Ω–æ–≤—ñ –µ–ª–µ–º–µ–Ω—Ç–∏`, time: Date.now() })
                });
            };

            const discardCards = async () => {
                if (selectedCards.length !== cardsToDiscard) {
                    showNotification('error', `–ù–µ–æ–±—Ö—ñ–¥–Ω–æ —Å–∫–∏–Ω—É—Ç–∏ —Ä—ñ–≤–Ω–æ ${cardsToDiscard} –∫–∞—Ä—Ç!`);
                    return;
                }
                
                let newHand = [...myPlayer.hand];
                // –°–æ—Ä—Ç—É—î–º–æ —ñ–Ω–¥–µ–∫—Å–∏ –∑–∞ —Å–ø–∞–¥–∞–Ω–Ω—è–º, —â–æ–± –≤–∏–¥–∞–ª–µ–Ω–Ω—è –Ω–µ –∑–±–∏–≤–∞–ª–æ –ø–æ—Ä—è–¥–æ–∫
                selectedCards.sort((a,b) => b-a).forEach(idx => {
                    newHand.splice(idx, 1);
                });
                
                const updatedPlayers = [...gameData.players];
                updatedPlayers[myIndex].hand = newHand;

                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                    players: updatedPlayers,
                    turnPhase: 'action', // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—å –¥–æ —Ñ–∞–∑–∏ –¥—ñ–π
                    logs: arrayUnion({ text: `${myPlayer.name} –æ—á–∏—Å—Ç–∏–≤ —ñ–Ω–≤–µ–Ω—Ç–∞—Ä`, time: Date.now() })
                });
                setSelectedCards([]);
            };

            const synthesizeMolecule = async (molecule) => {
                if (!checkRecipe(myPlayer.hand, molecule.req)) return;

                let newHand = [...myPlayer.hand];
                // –í–∏–¥–∞–ª—è—î–º–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ –∞—Ç–æ–º–∏
                Object.entries(molecule.req).forEach(([el, count]) => {
                    for(let i=0; i<count; i++) {
                        const idx = newHand.indexOf(el);
                        if (idx > -1) {
                            newHand.splice(idx, 1);
                        }
                    }
                });

                const updatedPlayers = [...gameData.players];
                updatedPlayers[myIndex] = {
                    ...myPlayer,
                    hand: newHand,
                    molecules: [...myPlayer.molecules, molecule.id],
                    score: myPlayer.score + molecule.vp
                };

                // –û–Ω–æ–≤–ª—é—î–º–æ —Ä–∏–Ω–æ–∫
                const newMarket = [...gameData.market];
                const marketIndex = newMarket.findIndex(m => m.uniqueId === molecule.uniqueId);
                newMarket.splice(marketIndex, 1);
                
                const newDeck = [...gameData.moleculeDeck];
                if (newDeck.length > 0) {
                    newMarket.push(newDeck.shift());
                }

                const status = updatedPlayers[myIndex].score >= WINNING_SCORE ? 'finished' : 'playing';

                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                    players: updatedPlayers,
                    status,
                    market: newMarket,
                    moleculeDeck: newDeck,
                    logs: arrayUnion({ text: `${myPlayer.name} —Å–∏–Ω—Ç–µ–∑—É–≤–∞–≤ ${molecule.name} (+${molecule.vp} VP)`, time: Date.now() })
                });
            };

            const endTurn = async () => {
                const nextIndex = (gameData.turnIndex + 1) % gameData.players.length;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                    turnIndex: nextIndex,
                    turnPhase: 'draw',
                    activeTrade: null, // –°–∫–∞—Å–æ–≤—É—î–º–æ –∞–∫—Ç–∏–≤–Ω—ñ —Ç–æ—Ä–≥–∏
                    logs: arrayUnion({ text: `–•—ñ–¥ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –¥–æ ${gameData.players[nextIndex].name}`, time: Date.now() })
                });
            };

            // --- –õ–û–ì–Ü–ö–ê –¢–û–†–ì–Ü–í–õ–Ü (–í—ñ–¥–Ω–æ–≤–ª–µ–Ω–∞ —Ç–∞ –†–æ–∑—à–∏—Ä–µ–Ω–∞) ---

            const executeBankTrade = async () => {
                // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ 3 –¥–æ 1
                if (selectedCards.length !== 3) {
                    showNotification('error', "–û–±–µ—Ä—ñ—Ç—å —Ä—ñ–≤–Ω–æ 3 –∫–∞—Ä—Ç–∏ –¥–ª—è –æ–±–º—ñ–Ω—É!");
                    return;
                }
                const firstCard = myPlayer.hand[selectedCards[0]];
                const allSame = selectedCards.every(idx => myPlayer.hand[idx] === firstCard);
                
                if (!allSame) {
                    showNotification('error', "–ö–∞—Ä—Ç–∏ –ø–æ–≤–∏–Ω–Ω—ñ –±—É—Ç–∏ –æ–¥–Ω–∞–∫–æ–≤–∏–º–∏ –¥–ª—è –æ–±–º—ñ–Ω—É –∑ –±–∞–Ω–∫–æ–º!");
                    return;
                }
                
                if (!tradeOffer.want) {
                    showNotification('error', "–û–±–µ—Ä—ñ—Ç—å, —â–æ —Ö–æ—á–µ—Ç–µ –æ—Ç—Ä–∏–º–∞—Ç–∏!");
                    return;
                }

                let newHand = [...myPlayer.hand];
                selectedCards.sort((a,b) => b-a).forEach(idx => newHand.splice(idx, 1));
                newHand.push(tradeOffer.want);

                const updatedPlayers = [...gameData.players];
                updatedPlayers[myIndex].hand = newHand;

                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                    players: updatedPlayers,
                    logs: arrayUnion({ text: `${myPlayer.name} –æ–±–º—ñ–Ω—è–≤ 3 ${firstCard} –Ω–∞ ${tradeOffer.want}`, time: Date.now() })
                });
                
                setTradeModalOpen(false);
                setSelectedCards([]);
                setTradeOffer({ give: [], want: '' });
            };

            const createPlayerTrade = async () => {
                if (selectedCards.length === 0) {
                    showNotification('error', "–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ä—Ç–∏, —è–∫—ñ –≤—ñ–¥–¥–∞—î—Ç–µ!");
                    return;
                }
                if (!tradeOffer.want) {
                    showNotification('error', "–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ä—Ç—É, —è–∫—É —Ö–æ—á–µ—Ç–µ!");
                    return;
                }

                const giveCards = selectedCards.map(idx => myPlayer.hand[idx]);
                
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                    activeTrade: {
                        initiator: user.uid,
                        give: giveCards,
                        want: tradeOffer.want,
                        giveIndices: selectedCards // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —ñ–Ω–¥–µ–∫—Å–∏, —Ö–æ—á–∞ –∫—Ä–∞—â–µ –ø–æ —Ç–∏–ø–∞–º
                    },
                    logs: arrayUnion({ text: `${myPlayer.name} –ø—Ä–æ–ø–æ–Ω—É—î –æ–±–º—ñ–Ω: ${giveCards.join(', ')} –Ω–∞ ${tradeOffer.want}`, time: Date.now() })
                });
                setTradeModalOpen(false);
                setSelectedCards([]);
            };

            const acceptActiveTrade = async () => {
                const trade = gameData.activeTrade;
                if (!trade) return;

                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —î —É –º–µ–Ω–µ (—Ç–æ–≥–æ —Ö—Ç–æ –ø—Ä–∏–π–º–∞—î) –ø–æ—Ç—Ä—ñ–±–Ω–∞ –∫–∞—Ä—Ç–∞
                const myRequiredCardIndex = myPlayer.hand.indexOf(trade.want);
                if (myRequiredCardIndex === -1) {
                    showNotification('error', `–£ –≤–∞—Å –Ω–µ–º–∞—î –µ–ª–µ–º–µ–Ω—Ç—É ${trade.want} –¥–ª—è –æ–±–º—ñ–Ω—É!`);
                    return;
                }

                // –ó–Ω–∞—Ö–æ–¥–∏–º–æ —ñ–Ω—ñ—Ü—ñ–∞—Ç–æ—Ä–∞
                const initiatorIndex = gameData.players.findIndex(p => p.uid === trade.initiator);
                const initiator = gameData.players[initiatorIndex];

                // --- –í–∏–∫–æ–Ω—É—î–º–æ –æ–±–º—ñ–Ω ---
                const newMyHand = [...myPlayer.hand];
                const newInitHand = [...initiator.hand];

                // 1. –Ø –≤—ñ–¥–¥–∞—é –∫–∞—Ä—Ç—É —ñ–Ω—ñ—Ü—ñ–∞—Ç–æ—Ä—É
                newMyHand.splice(myRequiredCardIndex, 1);
                newInitHand.push(trade.want);

                // 2. –Ü–Ω—ñ—Ü—ñ–∞—Ç–æ—Ä –≤—ñ–¥–¥–∞—î –º–µ–Ω—ñ —Å–≤–æ—ó –∫–∞—Ä—Ç–∏
                // –í–∞–∂–ª–∏–≤–æ: –≤–∏–¥–∞–ª—è—î–º–æ –ø–æ —Ç–∏–ø–∞—Ö, –∞ –Ω–µ —ñ–Ω–¥–µ–∫—Å–∞—Ö, –±–æ –º–∞—Å–∏–≤ –º—ñ–≥ –∑–º—ñ–Ω–∏—Ç–∏—Å—å (–º–∞–ª–æ–π–º–æ–≤—ñ—Ä–Ω–æ –≤ –ø–æ—Ç–æ—á–Ω—ñ–π –ª–æ–≥—ñ—Ü—ñ, –∞–ª–µ –±–µ–∑–ø–µ—á–Ω—ñ—à–µ)
                trade.give.forEach(cardType => {
                    const idx = newInitHand.indexOf(cardType);
                    if (idx > -1) newInitHand.splice(idx, 1);
                    newMyHand.push(cardType);
                });

                const updatedPlayers = [...gameData.players];
                updatedPlayers[myIndex].hand = newMyHand;
                updatedPlayers[initiatorIndex].hand = newInitHand;

                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                    players: updatedPlayers,
                    activeTrade: null,
                    logs: arrayUnion({ text: `–û–±–º—ñ–Ω –º—ñ–∂ ${initiator.name} —Ç–∞ ${myPlayer.name} —É—Å–ø—ñ—à–Ω–∏–π!`, time: Date.now() })
                });
            };

            const cancelActiveTrade = async () => {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                    activeTrade: null,
                    logs: arrayUnion({ text: `${myPlayer.name} —Å–∫–∞—Å—É–≤–∞–≤ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é –æ–±–º—ñ–Ω—É`, time: Date.now() })
                });
            };

            // –û–±—Ä–æ–±–∫–∞ –∫–ª—ñ–∫—É –Ω–∞ –∫–∞—Ä—Ç—É –≤ —Ä—É—Ü—ñ
            const handleCardClick = (idx) => {
                // –î–æ–∑–≤–æ–ª—è—î–º–æ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è —Ç—ñ–ª—å–∫–∏ —É –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ —Ñ–∞–∑–∏
                if (!isMyTurn) return;
                
                // –Ø–∫—â–æ –≤—ñ–¥–∫—Ä–∏—Ç–µ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ —Ç–æ—Ä–≥—ñ–≤–ª—ñ - –≤–∏–¥—ñ–ª–µ–Ω–Ω—è –ø—Ä–∞—Ü—é—î –¥–ª—è –Ω—å–æ–≥–æ
                // –Ø–∫—â–æ —Ñ–∞–∑–∞ —Å–∫–∏–¥–∞–Ω–Ω—è –∞–±–æ –¥—ñ—è (–¥–ª—è –ø—ñ–¥–≥–æ—Ç–æ–≤–∫–∏ —Ç–æ—Ä–≥—ñ–≤–ª—ñ)
                if (turnPhase === 'discard_force' || turnPhase === 'action') {
                    setSelectedCards(prev => prev.includes(idx) ? prev.filter(i => i !== idx) : [...prev, idx]);
                }
            };

            // --- –†–ï–ù–î–ï–†–ò–ù–ì UI ---

            if (loading) {
                return <div className="h-screen w-full bg-[#022c22] flex items-center justify-center"><Loader2 className="animate-spin text-yellow-500" size={64}/></div>;
            }

            // 1. –ï–ö–†–ê–ù –õ–û–ë–Ü (–í—Ö—ñ–¥)
            if (!gameData) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 bg-cover bg-center">
                        <div className="bg-[#064e3b]/90 backdrop-blur-md p-8 rounded-3xl shadow-2xl w-full max-w-md border-2 border-yellow-600">
                            <div className="text-center mb-8">
                                <h1 className="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600 mb-2 drop-shadow-lg" style={{fontFamily: 'Cinzel'}}>–°–ò–ù–¢–ï–ó</h1>
                                <p className="text-emerald-200 font-serif tracking-widest text-sm uppercase">–ê–ª—Ö—ñ–º—ñ—á–Ω–∞ –°—Ç—Ä–∞—Ç–µ–≥—ñ—è</p>
                            </div>
                            
                            <div className="space-y-4">
                                <input 
                                    type="text" 
                                    placeholder="–Ü–º'—è –ê–ª—Ö—ñ–º—ñ–∫–∞" 
                                    className="w-full p-4 bg-[#022c22] border-2 border-emerald-700 rounded-xl focus:border-yellow-500 focus:outline-none transition-colors text-yellow-100 font-bold text-lg text-center placeholder-emerald-700 shadow-inner"
                                    value={playerName}
                                    onChange={e => setPlayerName(e.target.value)}
                                />
                                
                                <button onClick={createGame} className="group w-full py-4 bg-gradient-to-r from-emerald-700 to-emerald-600 hover:from-emerald-600 hover:to-emerald-500 text-white rounded-xl font-bold text-lg shadow-lg border-b-4 border-emerald-900 active:border-b-0 active:translate-y-1 transition-all flex items-center justify-center gap-2">
                                    <FlaskConical className="group-hover:rotate-12 transition-transform" /> –í—ñ–¥–∫—Ä–∏—Ç–∏ –õ–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—é
                                </button>
                                
                                <div className="relative py-2">
                                    <div className="absolute inset-0 flex items-center"><div className="w-full border-t border-emerald-800"></div></div>
                                    <div className="relative flex justify-center"><span className="bg-[#064e3b] px-3 text-sm text-emerald-400 font-bold">–ê–ë–û</span></div>
                                </div>

                                <div className="flex gap-2">
                                    <input 
                                        type="text" 
                                        placeholder="–ö–û–î" 
                                        className="w-2/3 p-4 bg-[#022c22] border-2 border-emerald-700 rounded-xl font-mono text-center uppercase text-yellow-100 font-bold tracking-[0.2em] outline-none focus:border-yellow-500"
                                        value={targetGameId}
                                        onChange={e => setTargetGameId(e.target.value)}
                                    />
                                    <button onClick={() => joinGame(targetGameId)} className="flex-1 bg-yellow-600 hover:bg-yellow-500 text-black rounded-xl font-bold shadow-lg border-b-4 border-yellow-800 active:border-b-0 active:translate-y-1 transition-all flex items-center justify-center">
                                        <ArrowRightLeft />
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // 2. –ï–ö–†–ê–ù –û–ß–Ü–ö–£–í–ê–ù–ù–Ø
            if (gameData.status === 'waiting') {
                return (
                    <div className="min-h-screen bg-[#022c22] flex flex-col items-center justify-center p-4">
                        <div className="bg-[#064e3b] p-8 rounded-3xl shadow-2xl w-full max-w-lg text-center border-4 border-yellow-600 relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-yellow-600 via-yellow-300 to-yellow-600"></div>
                            
                            <h2 className="text-emerald-300 font-bold mb-2 uppercase tracking-wide text-xs">–ö–æ–¥ –¥–æ—Å—Ç—É–ø—É</h2>
                            <div className="text-6xl font-mono font-black text-yellow-400 tracking-[0.15em] mb-8 bg-[#022c22] py-6 rounded-xl border border-emerald-700 select-all shadow-inner">
                                {gameId}
                            </div>
                            
                            <div className="space-y-3 mb-8 text-left">
                                {gameData.players.map((p, i) => (
                                    <div key={i} className="flex items-center gap-4 p-4 bg-[#022c22] border border-emerald-800 rounded-2xl shadow-lg transform hover:scale-105 transition-transform">
                                        <div className="w-12 h-12 rounded-full bg-gradient-to-br from-yellow-500 to-yellow-700 flex items-center justify-center text-black font-black text-xl shadow-md border-2 border-yellow-300">
                                            {p.name[0]}
                                        </div>
                                        <div className="font-bold text-xl text-emerald-100 font-serif">{p.name}</div>
                                        {i === 0 && <Crown className="ml-auto text-yellow-400 drop-shadow-[0_0_10px_rgba(250,204,21,0.8)]" />}
                                    </div>
                                ))}
                                {[...Array(4 - gameData.players.length)].map((_, i) => (
                                    <div key={i} className="p-4 border-2 border-dashed border-emerald-800 rounded-2xl flex items-center justify-center text-emerald-700 font-bold uppercase tracking-wider">
                                        –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –∞–ª—Ö—ñ–º—ñ–∫–∞...
                                    </div>
                                ))}
                            </div>

                            {isHost ? (
                                <button onClick={startGame} className="w-full py-4 bg-gradient-to-r from-yellow-600 to-yellow-500 hover:from-yellow-500 hover:to-yellow-400 text-black rounded-xl font-black text-xl shadow-[0_0_20px_rgba(234,179,8,0.4)] transition-all active:scale-95 flex items-center justify-center gap-3">
                                    <FlaskConical className="animate-bounce" /> –ü–û–ß–ê–¢–ò –°–ò–ù–¢–ï–ó
                                </button>
                            ) : (
                                <div className="flex items-center justify-center gap-3 text-emerald-400 font-bold animate-pulse p-4 bg-[#022c22] rounded-xl">
                                    <Loader2 className="animate-spin"/> –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –≥–æ–ª–æ–≤–Ω–æ–≥–æ –∞–ª—Ö—ñ–º—ñ–∫–∞...
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // 3. –û–°–ù–û–í–ù–ò–ô –ï–ö–†–ê–ù –ì–†–ò
            return (
                <div className="h-screen flex flex-col relative overflow-hidden">
                    
                    {/* –í–ï–†–•–ù–Ø –ü–ê–ù–ï–õ–¨: –ì—Ä–∞–≤—Ü—ñ —Ç–∞ –°—Ç–∞—Ç—É—Å */}
                    <header className="bg-[#064e3b] shadow-xl z-50 shrink-0 border-b border-yellow-600/30">
                        {/* –†—è–¥–æ–∫ —Å—Ç–∞—Ç—É—Å—É */}
                        <div className="flex justify-between items-center px-4 py-2 bg-[#022c22]/50 backdrop-blur">
                            <div className="flex items-center gap-2">
                                <span className="text-yellow-500 font-black font-serif tracking-widest">–°–ò–ù–¢–ï–ó</span>
                                <span className="text-[10px] bg-emerald-900 text-emerald-300 px-2 py-0.5 rounded border border-emerald-700">
                                    –†–∞—É–Ω–¥ {Math.floor(gameData.turnIndex / gameData.players.length) + 1}
                                </span>
                            </div>
                            <button onClick={() => {if(confirm('–ü–æ–∫–∏–Ω—É—Ç–∏ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—é?')) setGameId('')}} className="text-emerald-500 hover:text-red-400 transition-colors">
                                <LogOut size={18}/>
                            </button>
                        </div>

                        {/* –°–ø–∏—Å–æ–∫ –≥—Ä–∞–≤—Ü—ñ–≤ (–°–∫—Ä–æ–ª) */}
                        <div className="flex overflow-x-auto p-3 gap-3 scrollbar-hide bg-[#064e3b]">
                            {gameData.players.map((p, i) => {
                                const isActive = gameData.turnIndex === i;
                                const isMe = p.uid === user.uid;
                                return (
                                    <div key={i} className={`
                                        flex-shrink-0 flex items-center gap-3 px-4 py-2 rounded-lg border-2 transition-all min-w-[140px]
                                        ${isActive ? 'bg-yellow-900/40 border-yellow-500 shadow-[0_0_15px_rgba(234,179,8,0.3)]' : 'bg-[#022c22] border-emerald-800 opacity-70'}
                                    `}>
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${isActive ? 'bg-yellow-500 text-black' : 'bg-emerald-800 text-emerald-300'}`}>
                                            {p.name[0]}
                                        </div>
                                        <div className="flex flex-col">
                                            <span className={`text-xs font-bold leading-none mb-1 ${isActive ? 'text-yellow-100' : 'text-emerald-400'}`}>
                                                {p.name} {isMe && '(–í–∏)'}
                                            </span>
                                            <div className="flex gap-2 text-[10px]">
                                                <span className="flex items-center gap-1 text-yellow-400">üèÜ {p.score}</span>
                                                <span className="flex items-center gap-1 text-emerald-300">üÉè {p.hand.length}</span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </header>

                    {/* –ê–õ–ï–†–¢ –ü–†–û–ü–û–ó–ò–¶–Ü–á –¢–û–†–ì–Ü–í–õ–Ü */}
                    {gameData.activeTrade && gameData.activeTrade.initiator !== user.uid && (
                        <div className="absolute top-32 left-0 right-0 z-[60] px-4 animate-in slide-in-from-top duration-500">
                            <div className="bg-gradient-to-r from-yellow-100 to-yellow-50 border-4 border-yellow-500 rounded-xl p-4 shadow-2xl flex flex-col items-center gap-3 text-black">
                                <div className="font-bold text-center">
                                    <span className="text-yellow-800 uppercase text-xs block mb-1">–í—Ö—ñ–¥–Ω–∞ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è</span>
                                    {gameData.players.find(p=>p.uid===gameData.activeTrade.initiator)?.name} –ø—Ä–æ–ø–æ–Ω—É—î <br/>
                                    <span className="font-black bg-yellow-200 px-2 rounded">{gameData.activeTrade.give.join(', ')}</span> –≤ –æ–±–º—ñ–Ω –Ω–∞ <span className="font-black bg-green-200 px-2 rounded">{gameData.activeTrade.want}</span>
                                </div>
                                <div className="flex gap-3 w-full">
                                    <button onClick={acceptActiveTrade} className="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-bold shadow-lg">–ü—Ä–∏–π–Ω—è—Ç–∏</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* –¶–ï–ù–¢–†–ê–õ–¨–ù–ê –û–ë–õ–ê–°–¢–¨ (–°–∫—Ä–æ–ª) */}
                    <div className="flex-1 overflow-y-auto p-4 pb-60 scrollbar-hide relative">
                        
                        {/* –†–∏–Ω–æ–∫ */}
                        <div className="mb-8">
                            <div className="flex justify-between items-end mb-4 px-2 border-b border-emerald-800 pb-2">
                                <h3 className="text-sm font-black text-emerald-400 uppercase tracking-[0.2em] flex items-center gap-2">
                                    <FlaskConical className="text-yellow-500"/> –†–∏–Ω–æ–∫ –§–æ—Ä–º—É–ª
                                </h3>
                                <div className="text-[10px] bg-emerald-900 text-emerald-400 px-2 py-1 rounded font-mono">
                                    –ó–∞–ª–∏—à–∏–ª–æ—Å—å: {gameData.moleculeDeck.length}
                                </div>
                            </div>
                            
                            <div className="flex flex-wrap gap-4 justify-center">
                                {gameData.market.map(mol => (
                                    <MoleculeCard 
                                        key={mol.uniqueId} 
                                        mol={mol} 
                                        canBuy={isMyTurn && turnPhase === 'action' && checkRecipe(myPlayer.hand, mol.req)}
                                        onBuy={synthesizeMolecule}
                                    />
                                ))}
                                {gameData.market.length === 0 && (
                                    <div className="w-full text-center py-10 text-emerald-600 italic border-2 border-dashed border-emerald-800 rounded-xl">
                                        –í—Å—ñ —Ñ–æ—Ä–º—É–ª–∏ –≤—ñ–¥–∫—Ä–∏—Ç–æ...
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* –ñ—É—Ä–Ω–∞–ª –ø–æ–¥—ñ–π (–õ–æ–≥–∏) - –ó–∞–≤–∂–¥–∏ –≤–∏–¥–∏–º–∏–π */}
                        <div className="bg-[#022c22]/80 border border-emerald-800 rounded-xl p-3 max-h-40 overflow-y-auto shadow-inner">
                            <div className="text-[10px] text-emerald-600 font-bold uppercase mb-2 sticky top-0 bg-[#022c22] pb-1">–•—Ä–æ–Ω—ñ–∫–∏</div>
                            {gameData.logs.slice().reverse().map((log, i) => (
                                <div key={i} className="mb-1.5 pb-1.5 border-b border-emerald-900/50 last:border-0 text-xs text-emerald-300 font-mono flex gap-2">
                                    <span className="opacity-40 text-[10px] pt-0.5">{new Date(log.time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>
                                    <span>{log.text}</span>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* –°–ü–û–í–Ü–©–ï–ù–ù–Ø (TOAST) */}
                    {notification && (
                        <div className={`fixed bottom-48 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full shadow-2xl text-white font-bold z-[100] animate-in slide-in-from-bottom-4 flex items-center gap-3 text-sm whitespace-nowrap border-2
                            ${notification.type === 'error' ? 'bg-red-900 border-red-500' : 'bg-emerald-800 border-emerald-500'}
                        `}>
                            {notification.type === 'error' ? <X/> : <CheckCircle2/>}
                            {notification.msg}
                        </div>
                    )}

                    {/* –ù–ò–ñ–ù–Ø –ü–ê–ù–ï–õ–¨: –î—ñ—ó —Ç–∞ –†—É–∫–∞ */}
                    <div className="absolute bottom-0 left-0 w-full z-40 flex flex-col justify-end pointer-events-none">
                        
                        {/* –ü–ª–∞–≤–∞—é—á—ñ –∫–Ω–æ–ø–∫–∏ –¥—ñ–π */}
                        <div className="flex justify-center mb-4 px-4 gap-3 pointer-events-auto">
                            {isMyTurn && (
                                <>
                                    {turnPhase === 'draw' && (
                                        <button onClick={drawCards} className="bg-gradient-to-r from-yellow-600 to-yellow-500 text-black px-8 py-3 rounded-full font-black shadow-[0_0_20px_rgba(234,179,8,0.5)] flex items-center gap-2 animate-bounce hover:scale-105 transition-transform">
                                            <History size={20}/> –î–û–°–õ–Ü–î–ò–¢–ò (–í–∑—è—Ç–∏ 2)
                                        </button>
                                    )}
                                    
                                    {turnPhase === 'action' && (
                                        <div className="flex gap-2 bg-[#022c22]/80 backdrop-blur-md p-2 rounded-full border border-emerald-600 shadow-xl">
                                            <button 
                                                onClick={() => { setTradeModalOpen(true); setSelectedCards([]); setTradeOffer({ give: [], want: '' }); }} 
                                                className="bg-purple-700 hover:bg-purple-600 text-white px-6 py-2 rounded-full font-bold flex items-center gap-2 transition-colors"
                                            >
                                                <RefreshCcw size={18}/> –û–ë–ú–Ü–ù
                                            </button>
                                            <button 
                                                onClick={endTurn} 
                                                className="bg-emerald-800 hover:bg-emerald-700 text-emerald-100 px-6 py-2 rounded-full font-bold transition-colors border border-emerald-600"
                                            >
                                                –ó–ê–í–ï–†–®–ò–¢–ò
                                            </button>
                                        </div>
                                    )}

                                    {isDiscardPhase && (
                                        <button onClick={discardCards} className="bg-red-600 text-white px-8 py-3 rounded-full font-bold shadow-lg flex items-center gap-2 animate-pulse hover:bg-red-700">
                                            <Trash2 size={20}/> –°–ö–ò–ù–£–¢–ò {cardsToDiscard - selectedCards.length}
                                        </button>
                                    )}
                                </>
                            )}

                            {/* –°–∫–∞—Å—É–≤–∞–Ω–Ω—è —Å–≤–æ–≥–æ –æ–±–º—ñ–Ω—É */}
                            {gameData.activeTrade && gameData.activeTrade.initiator === user.uid && (
                                <button onClick={cancelActiveTrade} className="bg-gray-600 text-white px-6 py-2 rounded-full font-bold shadow-lg hover:bg-gray-700">
                                    –°–∫–∞—Å—É–≤–∞—Ç–∏ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é
                                </button>
                            )}
                        </div>

                        {/* –ü–∞–Ω–µ–ª—å —Ä—É–∫–∏ –∫–∞—Ä—Ç–æ–∫ */}
                        <div className="bg-[#fcfcfc] w-full rounded-t-[2.5rem] shadow-[0_-10px_40px_rgba(0,0,0,0.5)] pt-3 pb-8 px-2 relative pointer-events-auto transition-transform hover:translate-y-0 translate-y-2 border-t-4 border-yellow-500">
                            {/* –î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω–∞ —Ä—É—á–∫–∞ */}
                            <div className="w-16 h-1.5 bg-gray-300 rounded-full mx-auto mb-3"></div>
                            
                            <div className="text-center text-[10px] text-gray-400 font-black uppercase tracking-widest mb-2">
                                –í–∞—à—ñ –ï–ª–µ–º–µ–Ω—Ç–∏ ({myPlayer?.hand.length}/10)
                            </div>

                            <div className="overflow-x-auto overflow-y-visible flex justify-center px-4 py-4 min-h-[160px] scrollbar-hide pb-10">
                                <div className="flex -space-x-12 sm:-space-x-8 px-8">
                                    {/* –°–æ—Ä—Ç—É—î–º–æ –∫–∞—Ä—Ç–∏ –¥–ª—è –∑—Ä—É—á–Ω–æ—Å—Ç—ñ */}
                                    {myPlayer?.hand
                                        .map((card, idx) => ({ card, idx }))
                                        .sort((a, b) => a.card.localeCompare(b.card))
                                        .map(({ card, idx }, i, arr) => {
                                            const isSelected = selectedCards.includes(idx);
                                            // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –≤—ñ—è–ª–∞
                                            const rotation = (i - (arr.length - 1) / 2) * 5; 
                                            const translateY = Math.abs(i - (arr.length - 1) / 2) * 2;
                                            
                                            return (
                                                <div key={idx} className="relative transition-all duration-300 origin-bottom" 
                                                     style={{ 
                                                         zIndex: isSelected ? 50 : i,
                                                         transform: `rotate(${rotation}deg) translateY(${translateY}px)` 
                                                     }}>
                                                    <ElementCard 
                                                        type={card} 
                                                        selected={isSelected}
                                                        onClick={() => handleCardClick(idx)}
                                                    />
                                                </div>
                                            );
                                        })
                                    }
                                    {myPlayer?.hand.length === 0 && (
                                        <div className="text-gray-400 font-bold italic mt-8">–Ü–Ω–≤–µ–Ω—Ç–∞—Ä –ø—É—Å—Ç–∏–π</div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* –ú–û–î–ê–õ–¨–ù–ï –í–Ü–ö–ù–û –¢–û–†–ì–Ü–í–õ–Ü */}
                    <Modal 
                        isOpen={isTradeModalOpen} 
                        onClose={() => setTradeModalOpen(false)} 
                        title="–¶–µ–Ω—Ç—Ä –û–±–º—ñ–Ω—É"
                    >
                        {/* –í–∫–ª–∞–¥–∫–∏ */}
                        <div className="flex mb-6 bg-emerald-100 p-1 rounded-xl">
                            <button 
                                onClick={() => setTradeTab('bank')} 
                                className={`flex-1 py-2 rounded-lg font-bold text-sm transition-all ${tradeTab==='bank' ? 'bg-yellow-500 text-black shadow-md' : 'text-emerald-700 hover:bg-emerald-200'}`}
                            >
                                –ë–∞–Ω–∫ (3:1)
                            </button>
                            <button 
                                onClick={() => setTradeTab('player')} 
                                className={`flex-1 py-2 rounded-lg font-bold text-sm transition-all ${tradeTab==='player' ? 'bg-purple-600 text-white shadow-md' : 'text-emerald-700 hover:bg-emerald-200'}`}
                            >
                                –ì—Ä–∞–≤—Ü—ñ
                            </button>
                        </div>

                        {/* –ö—Ä–æ–∫ 1: –©–æ –≤—ñ–¥–¥–∞—î–º–æ */}
                        <div className="mb-4">
                            <h4 className="text-xs font-bold text-gray-500 uppercase mb-2">1. –í–∏ –≤—ñ–¥–¥–∞—î—Ç–µ (–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ä—Ç–∏ –≤ —Ä—É—Ü—ñ):</h4>
                            <div className="flex gap-2 min-h-[60px] p-2 bg-white border-2 border-dashed border-gray-300 rounded-xl overflow-x-auto items-center">
                                {selectedCards.length > 0 ? (
                                    selectedCards.map(idx => (
                                        <div key={idx} className={`px-2 py-1 rounded border font-bold text-xs ${ELEMENTS[myPlayer.hand[idx]].color}`}>
                                            {myPlayer.hand[idx]}
                                        </div>
                                    ))
                                ) : (
                                    <span className="text-gray-400 text-xs italic mx-auto">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –Ω–∞ –∫–∞—Ä—Ç–∏ –∑–Ω–∏–∑—É</span>
                                )}
                            </div>
                        </div>

                        {/* –ö—Ä–æ–∫ 2: –©–æ —Ö–æ—á–µ–º–æ */}
                        <div className="mb-6">
                            <h4 className="text-xs font-bold text-gray-500 uppercase mb-2">2. –í–∏ –æ—Ç—Ä–∏–º—É—î—Ç–µ:</h4>
                            <div className="grid grid-cols-5 gap-2">
                                {Object.keys(ELEMENTS).map(el => (
                                    <button 
                                        key={el} 
                                        onClick={() => setTradeOffer(prev => ({ ...prev, want: el }))}
                                        className={`
                                            p-2 rounded-lg border-2 font-bold text-sm flex items-center justify-center transition-all
                                            ${tradeOffer.want === el 
                                                ? 'bg-green-600 text-white border-green-700 shadow-lg scale-110' 
                                                : 'bg-white text-gray-700 border-gray-200 hover:border-green-400'}
                                        `}
                                    >
                                        {el}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* –ö–Ω–æ–ø–∫–∞ –¥—ñ—ó */}
                        <button 
                            onClick={tradeTab === 'bank' ? executeBankTrade : createPlayerTrade}
                            className={`
                                w-full py-4 rounded-xl font-bold text-lg text-white shadow-lg transition-transform active:scale-95
                                ${tradeTab === 'bank' ? 'bg-yellow-600 hover:bg-yellow-500' : 'bg-purple-700 hover:bg-purple-600'}
                            `}
                        >
                            {tradeTab === 'bank' ? '–û–±–º—ñ–Ω—è—Ç–∏ (3 –¥–æ 1)' : '–°—Ç–≤–æ—Ä–∏—Ç–∏ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é'}
                        </button>
                    </Modal>

                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<SynthesisGame />);
    </script>
</body>
</html>
