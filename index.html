<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>СИНТЕЗ - Хімічна Стратегія</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚛️</text></svg>">
    <!-- Підключаємо Tailwind CSS для стилів -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Підключаємо Babel для розуміння React коду -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Стилі для скролбару та анімацій -->
    <style>
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Основний скрипт гри -->
    <script type="text/babel" data-type="module">
        // --- ІМПОРТИ БІБЛІОТЕК З CDN ---
        import React, { useState, useEffect, useMemo, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, 
            arrayUnion, runTransaction 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { 
            getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            Atom, FlaskConical, Users, Copy, Check, AlertTriangle, 
            ArrowRightLeft, Play, RotateCcw, Crown, LogOut, Loader2, X, RefreshCcw, LayoutGrid, Menu, History 
        } from 'https://esm.sh/lucide-react@0.263.1';

        // ==========================================
        // НАЛАШТУВАННЯ FIREBASE (ВАЖЛИВО!)
        // Замініть цей об'єкт на конфігурацію вашого проекту з Firebase Console
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyCCMdryzKt4-sRq2snh16Ciug2V_cRcBIU",
            authDomain: "synthesis-game-chem.firebaseapp.com",
            projectId: "synthesis-game-chem",
            storageBucket: "synthesis-game-chem.firebasestorage.app",
            messagingSenderId: "441318316675",
            appId: "1:441318316675:web:361daca49c3924e94a99b6"
        };
        
        // Ініціалізація Firebase
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Помилка ініціалізації Firebase. Перевірте конфігурацію.", e);
        }

        const appId = 'synthesis-game'; // ID колекції в базі даних

        // --- КОНФІГУРАЦІЯ ГРИ ТА ДАНІ ---

        const ELEMENT_DISTRIBUTION = {
            'H': 24, 'O': 34, 'C': 12, 'Na': 10, 'Cl': 7, 'Ca': 8, 'N': 7, 'S': 6, 'Si': 4
        };

        const ELEMENTS = {
            'H':  { m: 1,  name: 'Гідроген', color: 'bg-blue-100 text-blue-900 border-blue-300' },
            'O':  { m: 16, name: 'Оксиген',  color: 'bg-red-100 text-red-900 border-red-300' },
            'C':  { m: 12, name: 'Карбон',   color: 'bg-gray-200 text-gray-900 border-gray-400' },
            'N':  { m: 14, name: 'Нітроген', color: 'bg-indigo-100 text-indigo-900 border-indigo-300' },
            'Na': { m: 23, name: 'Натрій',   color: 'bg-purple-100 text-purple-900 border-purple-300' },
            'Cl': { m: 35.5, name: 'Хлор',   color: 'bg-green-100 text-green-900 border-green-300' },
            'Ca': { m: 40, name: 'Кальцій',  color: 'bg-orange-100 text-orange-900 border-orange-300' },
            'S':  { m: 32, name: 'Сульфур',  color: 'bg-yellow-100 text-yellow-900 border-yellow-400' },
            'Si': { m: 28, name: 'Силіцій',  color: 'bg-stone-200 text-stone-800 border-stone-400' },
        };

        const MOLECULES_LIST = [
            // Прості
            { id: 'h2o',     f: 'H₂O',      name: 'Вода',              vp: 3, count: 6, req: { 'H': 2, 'O': 1 } },
            { id: 'co',      f: 'CO',       name: 'Чадний газ',        vp: 4, count: 4, req: { 'C': 1, 'O': 1 } },
            { id: 'hcl',     f: 'HCl',      name: 'Хлоридна кислота',  vp: 6, count: 3, req: { 'H': 1, 'Cl': 1 } },
            { id: 'cao',     f: 'CaO',      name: 'Негашене вапно',    vp: 4, count: 3, req: { 'Ca': 1, 'O': 1 } },
            // Середні
            { id: 'co2',     f: 'CO₂',      name: 'Вуглекислий газ',   vp: 5, count: 5, req: { 'C': 1, 'O': 2 } },
            { id: 'nacl',    f: 'NaCl',     name: 'Кухонна сіль',      vp: 8, count: 4, req: { 'Na': 1, 'Cl': 1 } },
            { id: 'naoh',    f: 'NaOH',     name: 'Каустична сода',    vp: 5, count: 3, req: { 'Na': 1, 'O': 1, 'H': 1 } },
            { id: 'nh3',     f: 'NH₃',      name: 'Аміак',             vp: 8, count: 2, req: { 'N': 1, 'H': 3 } },
            { id: 'h2o2',    f: 'H₂O₂',     name: 'Перекис водню',     vp: 4, count: 2, req: { 'H': 2, 'O': 2 } },
            { id: 'so2',     f: 'SO₂',      name: 'Сірчистий газ',     vp: 4, count: 2, req: { 'S': 1, 'O': 2 } },
            { id: 'sio2',    f: 'SiO₂',     name: 'Пісок',             vp: 10, count: 2, req: { 'Si': 1, 'O': 2 } },
            // Складні
            { id: 'caoh2',   f: 'Ca(OH)₂',  name: 'Гашене вапно',      vp: 7, count: 2, req: { 'Ca': 1, 'O': 2, 'H': 2 } },
            { id: 'h2so4',   f: 'H₂SO₄',    name: 'Сульфатна кислота', vp: 12, count: 1, req: { 'H': 2, 'S': 1, 'O': 4 } },
            { id: 'caco3',   f: 'CaCO₃',    name: 'Крейда',            vp: 9, count: 3, req: { 'Ca': 1, 'C': 1, 'O': 3 } },
            { id: 'nahco3',  f: 'NaHCO₃',   name: 'Харчова сода',      vp: 10, count: 3, req: { 'Na': 1, 'H': 1, 'C': 1, 'O': 3 } },
            { id: 'na2co3',  f: 'Na₂CO₃',   name: 'Кальцинована сода', vp: 12, count: 3, req: { 'Na': 2, 'C': 1, 'O': 3 } },
        ];

        const WINNING_SCORE = 50;

        // --- ДОПОМІЖНІ ФУНКЦІЇ ---
        const shuffleArray = (array) => {
            let arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        };

        const generateElementDeck = () => {
            let deck = [];
            Object.entries(ELEMENT_DISTRIBUTION).forEach(([el, count]) => {
                for (let i = 0; i < count; i++) deck.push(el);
            });
            return shuffleArray(deck);
        };

        const generateMoleculeDeck = () => {
            let deck = [];
            MOLECULES_LIST.forEach(mol => {
                for (let i = 0; i < (mol.count || 1); i++) {
                    deck.push({ ...mol, uniqueId: `${mol.id}_${i}_${Math.random().toString(36).substr(2, 5)}` });
                }
            });
            return shuffleArray(deck);
        };

        const checkRecipe = (hand, recipe) => {
            const handCounts = {};
            hand.forEach(el => handCounts[el] = (handCounts[el] || 0) + 1);
            for (const [el, needed] of Object.entries(recipe)) {
                if (!handCounts[el] || handCounts[el] < needed) return false;
            }
            return true;
        };

        // --- КОМПОНЕНТИ ---

        const ElementCard = ({ type, count, mini = false, onClick, selected = false, style, overlap = false }) => {
            const data = ELEMENTS[type] || { m: '?', name: type, color: 'bg-gray-300' };
            
            if (mini) {
                return (
                    <div 
                        className={`
                        relative flex items-center justify-center w-10 h-12 rounded border shadow-sm select-none
                        ${data.color} ${selected ? 'ring-2 ring-blue-600 scale-110 z-10' : ''}
                        cursor-pointer transition-all
                        `}
                        onClick={onClick}
                    >
                        <span className="font-bold text-sm">{type}</span>
                    </div>
                );
            }

            return (
                <div 
                    onClick={onClick}
                    style={style}
                    className={`
                        relative w-20 h-32 sm:w-24 sm:h-36 rounded-xl shadow-md border-2 flex flex-col justify-between p-2 select-none transition-all duration-300 flex-shrink-0
                        ${data.color} ${selected ? 'ring-4 ring-blue-500 -translate-y-6 sm:-translate-y-8 z-30' : 'hover:-translate-y-2 sm:hover:-translate-y-4 hover:z-20'}
                        ${overlap ? '-ml-10 sm:-ml-12 hover:ml-1' : ''}
                        cursor-pointer bg-gradient-to-br from-white/60 to-transparent
                    `}
                >
                    {/* Верх: Символ зліва, Маса справа */}
                    <div className="flex justify-between items-start font-bold leading-none">
                        <span className="text-base sm:text-lg">{type}</span>
                        <span className="text-[10px] sm:text-xs opacity-60 pt-1">{data.m}</span>
                    </div>

                    {/* Центр */}
                    <div className="flex flex-col items-center justify-center flex-grow">
                        <span className="text-3xl sm:text-4xl font-black font-serif opacity-90">{type}</span>
                        <span className="text-[0.5rem] sm:text-[0.6rem] uppercase tracking-wider opacity-70 mt-1 text-center leading-tight truncate w-full">{data.name}</span>
                    </div>

                    {/* Низ: Символ зліва, Маса справа (обернуті) */}
                    <div className="flex justify-between items-end font-bold leading-none rotate-180">
                        <span className="text-base sm:text-lg">{type}</span>
                        <span className="text-[10px] sm:text-xs opacity-60 pb-1">{data.m}</span>
                    </div>
                </div>
            );
        };

        const MoleculeCard = ({ mol, canBuy, onBuy }) => {
            return (
                <div className={`
                    relative w-[45%] sm:w-36 h-auto min-h-[160px] sm:min-h-[180px] bg-[#fffdf5] rounded-xl border-2 border-[#006400] shadow-lg flex flex-col
                    ${canBuy ? 'ring-4 ring-green-400 cursor-pointer hover:scale-105' : 'opacity-100'}
                    transition-all mb-2
                `} onClick={() => canBuy && onBuy(mol)}>
                    <div className="absolute top-0 right-0 bg-[#006400] text-white text-[10px] sm:text-xs px-2 py-1 rounded-bl-lg font-bold">
                        {mol.vp} VP
                    </div>
                    <div className="p-2 sm:p-3 text-center border-b border-[#006400]/20 mt-2">
                        <div className="text-xl sm:text-2xl font-bold text-gray-800 font-serif leading-tight">{mol.f}</div>
                        <div className="text-[0.6rem] sm:text-[0.7rem] uppercase text-gray-600 mt-1 font-bold line-clamp-2 min-h-[1.5em]">{mol.name}</div>
                    </div>
                    <div className="p-2 flex flex-wrap justify-center gap-1 bg-gradient-to-b from-transparent to-[#fceeb5]/30 flex-grow content-center">
                        {Object.entries(mol.req).map(([el, count]) => (
                        <div key={el} className={`
                            text-[0.6rem] sm:text-[0.65rem] px-1.5 sm:px-2 py-0.5 rounded-full border border-black/10 font-bold flex items-center gap-1 shadow-sm
                            ${ELEMENTS[el]?.color || 'bg-gray-200'}
                        `}>
                            <span>{el}</span>
                            {count > 1 && <span>x{count}</span>}
                        </div>
                        ))}
                    </div>
                    {canBuy && (
                        <div className="absolute inset-0 bg-green-500/20 flex items-center justify-center rounded-xl opacity-0 hover:opacity-100 transition-opacity backdrop-blur-[1px]">
                            <span className="bg-green-600 text-white px-3 py-1 sm:px-4 sm:py-2 rounded-full shadow-lg font-bold text-xs sm:text-sm transform scale-105">Синтез</span>
                        </div>
                    )}
                </div>
            );
        };

        const ElementSelectorModal = ({ isOpen, onClose, onSelect, title }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg p-4 sm:p-6 animate-in fade-in zoom-in duration-200">
                        <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg sm:text-xl font-bold text-gray-800">{title}</h3>
                        <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-full bg-gray-50"><X size={20}/></button>
                        </div>
                        <div className="grid grid-cols-4 gap-2 sm:gap-3 max-h-[60vh] overflow-y-auto p-1">
                        {Object.keys(ELEMENTS).map(el => (
                            <div key={el} onClick={() => onSelect(el)} className="cursor-pointer hover:scale-105 transition-transform flex justify-center">
                            <ElementCard type={el} mini />
                            </div>
                        ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- ГОЛОВНИЙ КОМПОНЕНТ ДОДАТКУ ---

        const SynthesisGame = () => {
            const [user, setUser] = useState(null);
            const [gameId, setGameId] = useState('');
            const [gameData, setGameData] = useState(null);
            const [loading, setLoading] = useState(false);
            
            // Selection States
            const [selectedCards, setSelectedCards] = useState([]);
            const [notification, setNotification] = useState(null);
            const [playerName, setPlayerName] = useState('Хімік');
            const [targetGameId, setTargetGameId] = useState('');

            // Mobile Menu State
            const [isMobileMenuOpen, setMobileMenuOpen] = useState(false);
            const [mobileTab, setMobileTab] = useState('players'); // 'players' | 'logs'

            // Trade States
            const [is3to1ModalOpen, set3to1ModalOpen] = useState(false);
            const [tradeMode, setTradeMode] = useState(false);
            const [tradeStep, setTradeStep] = useState(0); 
            const [tradeOffer, setTradeOffer] = useState({ giveIdx: null, wantEl: null, targetUid: null });

            // Auth
            useEffect(() => {
                if (!auth) return;
                const initAuth = async () => {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Auth error:", error);
                        setNotification({ type: 'error', msg: "Помилка автентифікації. Перевірте конфіг Firebase." });
                    }
                };
                initAuth();
                return onAuthStateChanged(auth, u => setUser(u));
            }, []);

            // Sync Data
            useEffect(() => {
                if (!gameId || !user || !db) return;
                const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
                const unsubscribe = onSnapshot(gameRef, (snap) => {
                    if (snap.exists()) {
                        setGameData(snap.data());
                    } else {
                        setNotification({ type: 'error', msg: 'Кімнату не знайдено' });
                        setGameId('');
                    }
                }, (err) => {
                    console.error(err);
                    setNotification({ type: 'error', msg: "Помилка доступу до бази даних" });
                });
                return () => unsubscribe();
            }, [gameId, user]);

            const myIndex = gameData?.players.findIndex(p => p.uid === user?.uid) ?? -1;
            const myPlayer = myIndex !== -1 ? gameData.players[myIndex] : null;
            const isMyTurn = gameData?.status === 'playing' && gameData?.turnIndex === myIndex;
            const isHost = gameData?.players[0].uid === user?.uid;

            const sortedHandMap = useMemo(() => {
                if (!myPlayer) return [];
                return myPlayer.hand
                    .map((card, originalIdx) => ({ card, originalIdx }))
                    .sort((a, b) => {
                        if (a.card === b.card) return a.originalIdx - b.originalIdx;
                        return a.card.localeCompare(b.card);
                    });
            }, [myPlayer?.hand]);

            // --- ДІЇ ---

            const createGame = async () => {
                if (!user || !db) return;
                setLoading(true);
                const newGameId = Math.random().toString(36).substring(2, 8).toUpperCase();
                
                const molDeck = generateMoleculeDeck();
                const initialMarket = molDeck.splice(0, 4); 

                const initialData = {
                    id: newGameId,
                    status: 'waiting', 
                    players: [{
                        uid: user.uid,
                        name: playerName || 'Хімік-1',
                        hand: [],
                        score: 0,
                        molecules: []
                    }],
                    elementDeck: generateElementDeck(),
                    moleculeDeck: molDeck,
                    market: initialMarket,
                    discardPile: [],
                    turnIndex: 0,
                    logs: [{ text: `Гру створено гравцем ${playerName}`, time: Date.now() }],
                    turnPhase: 'draw', 
                    activeTrade: null 
                };
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', newGameId), initialData);
                setGameId(newGameId);
                setLoading(false);
            };

            const joinGame = async (code) => {
                if (!user || !code || !db) return;
                setLoading(true);
                const codeUpper = code.toUpperCase().trim();
                const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', codeUpper);
                try {
                    await runTransaction(db, async (transaction) => {
                        const sfDoc = await transaction.get(gameRef);
                        if (!sfDoc.exists()) throw "Кімнати не існує";
                        const data = sfDoc.data();
                        if (data.status !== 'waiting' && !data.players.some(p => p.uid === user.uid)) throw "Гра вже почалась";
                        if (data.players.some(p => p.uid === user.uid)) return;
                        if (data.players.length >= 4) throw "Кімната переповнена";

                        const newPlayer = { uid: user.uid, name: playerName, hand: [], score: 0, molecules: [] };
                        transaction.update(gameRef, {
                        players: arrayUnion(newPlayer),
                        logs: arrayUnion({ text: `${playerName} приєднався`, time: Date.now() })
                        });
                    });
                    setGameId(codeUpper);
                } catch (e) {
                    setNotification({ type: 'error', msg: e.toString() });
                }
                setLoading(false);
            };

            const startGame = async () => {
                if (!gameData || !db) return;
                const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
                const newDeck = [...gameData.elementDeck];
                const updatedPlayers = gameData.players.map(p => ({ ...p, hand: newDeck.splice(0, 5) }));
                await updateDoc(gameRef, {
                    status: 'playing', elementDeck: newDeck, players: updatedPlayers, turnPhase: 'draw',
                    logs: arrayUnion({ text: 'Гра почалася! Роздано по 5 карт.', time: Date.now() })
                });
            };

            const drawCards = async (count = 2) => {
                if (!gameData || !isMyTurn || gameData.turnPhase !== 'draw') return;
                const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
                let newDeck = [...gameData.elementDeck];
                
                if (newDeck.length < count) {
                    if (gameData.discardPile.length > 0) {
                        newDeck.push(...shuffleArray(gameData.discardPile));
                        await updateDoc(gameRef, { elementDeck: newDeck, discardPile: [] });
                        return; 
                    } else {
                        setNotification({ type: 'error', msg: 'Колода пуста!' });
                        return;
                    }
                }

                const drawn = newDeck.splice(0, count);
                const updatedPlayers = [...gameData.players];
                updatedPlayers[myIndex].hand.push(...drawn);

                await updateDoc(gameRef, {
                    elementDeck: newDeck, players: updatedPlayers, turnPhase: 'action',
                    logs: arrayUnion({ text: `${myPlayer.name} взяв ${count} карти`, time: Date.now() })
                });
            };

            const synthesize = async (molecule) => {
                if (!gameData || !isMyTurn || gameData.turnPhase !== 'action') return;
                const player = gameData.players[myIndex];
                
                const marketIndex = gameData.market.findIndex(m => m.uniqueId === molecule.uniqueId);
                if (marketIndex === -1) {
                    setNotification({type:'error', msg: "Цю картку вже хтось забрав!"});
                    return;
                }

                if (!checkRecipe(player.hand, molecule.req)) return;

                let newHand = [...player.hand];
                const discarded = [];
                Object.entries(molecule.req).forEach(([el, count]) => {
                    for(let i=0; i<count; i++) {
                        const idx = newHand.indexOf(el);
                        if (idx > -1) { discarded.push(newHand[idx]); newHand.splice(idx, 1); }
                    }
                });

                const updatedPlayers = [...gameData.players];
                updatedPlayers[myIndex] = { ...player, hand: newHand, molecules: [...player.molecules, molecule.id], score: player.score + molecule.vp };
                
                const newMarket = [...gameData.market];
                const newMoleculeDeck = [...gameData.moleculeDeck];
                newMarket.splice(marketIndex, 1); 
                
                if (newMoleculeDeck.length > 0) {
                    newMarket.push(newMoleculeDeck.shift());
                }

                let status = updatedPlayers[myIndex].score >= WINNING_SCORE ? 'finished' : 'playing';
                
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                    players: updatedPlayers, 
                    discardPile: [...gameData.discardPile, ...discarded], 
                    status,
                    market: newMarket,
                    moleculeDeck: newMoleculeDeck,
                    logs: arrayUnion({ text: `${player.name} синтезував ${molecule.name} (+${molecule.vp} VP)`, time: Date.now() })
                });
            };

            const startTrade3to1 = () => {
                if (selectedCards.length !== 3) {
                    setNotification({ type: 'error', msg: 'Виберіть рівно 3 карти' }); return;
                }
                const hand = myPlayer.hand;
                const firstCard = hand[selectedCards[0]];
                if (!selectedCards.every(idx => hand[idx] === firstCard)) {
                    setNotification({ type: 'error', msg: 'Карти мають бути однакові!' }); return;
                }
                set3to1ModalOpen(true);
            };

            const confirmTrade3to1 = async (wantedElement) => {
                const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
                const hand = myPlayer.hand;
                const firstCard = hand[selectedCards[0]];
                let newHand = [...hand];
                selectedCards.sort((a,b) => b-a).forEach(idx => newHand.splice(idx, 1));
                newHand.push(wantedElement);

                const updatedPlayers = [...gameData.players];
                updatedPlayers[myIndex].hand = newHand;

                await updateDoc(gameRef, {
                    players: updatedPlayers,
                    discardPile: [...gameData.discardPile, firstCard, firstCard, firstCard],
                    logs: arrayUnion({ text: `${myPlayer.name} обміняв 3 ${firstCard} на ${wantedElement}`, time: Date.now() })
                });
                setSelectedCards([]);
                set3to1ModalOpen(false);
            };

            const initPlayerTrade = () => {
                if (selectedCards.length !== 1) {
                    setNotification({ type: 'error', msg: 'Виберіть 1 карту, яку хочете віддати' });
                    return;
                }
                setTradeOffer({ giveIdx: selectedCards[0], wantEl: null, targetUid: null });
                setTradeMode(true);
                setTradeStep(1); 
            };

            const handleTradeStepSelection = (val) => {
                if (tradeStep === 1) { 
                    setTradeOffer(prev => ({ ...prev, wantEl: val }));
                    setTradeStep(2); 
                }
            };

            const sendTradeOffer = async (targetUid) => {
                if (!tradeOffer.wantEl || tradeOffer.giveIdx === null) return;
                const cardToGive = myPlayer.hand[tradeOffer.giveIdx];
                const targetName = gameData.players.find(p => p.uid === targetUid).name;
                const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
                await updateDoc(gameRef, {
                    activeTrade: {
                        fromUid: user.uid, fromName: myPlayer.name, targetUid: targetUid, targetName: targetName,
                        giveCard: cardToGive, giveCardIdx: tradeOffer.giveIdx, wantCard: tradeOffer.wantEl, status: 'pending'
                    },
                    logs: arrayUnion({ text: `${myPlayer.name} пропонує обмін ${targetName}`, time: Date.now() })
                });
                setTradeMode(false); setTradeStep(0); setSelectedCards([]);
                setNotification({ type: 'success', msg: 'Пропозицію відправлено!' });
            };

            const respondToTrade = async (accepted) => {
                if (!gameData.activeTrade) return;
                const trade = gameData.activeTrade;
                const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
                if (!accepted) {
                    await updateDoc(gameRef, { activeTrade: null, logs: arrayUnion({ text: `Обмін скасовано`, time: Date.now() }) });
                    return;
                }
                const myHand = myPlayer.hand;
                const cardIdx = myHand.indexOf(trade.wantCard);
                if (cardIdx === -1) {
                    setNotification({ type: 'error', msg: `У вас немає карти ${trade.wantCard}!` });
                    await updateDoc(gameRef, { activeTrade: null });
                    return;
                }
                try {
                    await runTransaction(db, async (transaction) => {
                        const sfDoc = await transaction.get(gameRef);
                        const gd = sfDoc.data();
                        if (!gd.activeTrade || gd.activeTrade.status !== 'pending') throw "Обмін вже неактуальний";
                        const sender = gd.players.find(p => p.uid === trade.fromUid);
                        const receiver = gd.players[myIndex];
                        
                        const senderCardIdx = sender.hand.indexOf(trade.giveCard);
                        if (senderCardIdx === -1) throw "У відправника зникла карта";
                        sender.hand.splice(senderCardIdx, 1); sender.hand.push(trade.wantCard);

                        const receiverCardIdx = receiver.hand.indexOf(trade.wantCard);
                        if (receiverCardIdx === -1) throw "У вас зникла карта";
                        receiver.hand.splice(receiverCardIdx, 1); receiver.hand.push(trade.giveCard);

                        transaction.update(gameRef, {
                        players: gd.players, activeTrade: null,
                        logs: arrayUnion({ text: `Обмін успішний: ${trade.giveCard} ↔ ${trade.wantCard}`, time: Date.now() })
                        });
                    });
                } catch(e) {
                    setNotification({ type: 'error', msg: e.toString() });
                }
            };

            const endTurn = async () => {
                if (myPlayer.hand.length > 10) {
                    setNotification({ type: 'error', msg: 'Більше 10 карт! Скиньте зайве.' }); return;
                }
                const nextIndex = (gameData.turnIndex + 1) % gameData.players.length;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), {
                    turnIndex: nextIndex, turnPhase: 'draw', activeTrade: null,
                    logs: arrayUnion({ text: `Хід переходить до ${gameData.players[nextIndex].name}`, time: Date.now() })
                });
            };

            const discardSelected = async () => {
                if (selectedCards.length === 0) return;
                const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
                let newHand = [...myPlayer.hand];
                const discarded = [];
                selectedCards.sort((a,b) => b-a).forEach(idx => { discarded.push(newHand[idx]); newHand.splice(idx, 1); });
                const updatedPlayers = [...gameData.players];
                updatedPlayers[myIndex].hand = newHand;
                await updateDoc(gameRef, {
                    players: updatedPlayers, discardPile: [...gameData.discardPile, ...discarded],
                    logs: arrayUnion({ text: `${myPlayer.name} скинув ${discarded.length} карт`, time: Date.now() })
                });
                setSelectedCards([]);
            };

            const toggleSelectCard = (originalIdx) => {
                if (selectedCards.includes(originalIdx)) {
                    setSelectedCards(selectedCards.filter(i => i !== originalIdx));
                } else {
                    setSelectedCards([...selectedCards, originalIdx]);
                }
            };

            // --- RENDER ---

            if (!user && !gameId) {
                if (!app) return <div className="h-screen flex items-center justify-center text-red-500 font-bold p-4 text-center">Firebase не налаштовано. Відкрийте код файлу і додайте конфігурацію.</div>
                return <div className="h-screen flex items-center justify-center gap-2 text-gray-500 font-bold"><Loader2 className="animate-spin"/> Завантаження...</div>;
            }

            if (!gameId || !gameData) {
                // LOBBY
                return (
                    <div className="min-h-screen bg-gradient-to-br from-[#1a1a1a] to-[#2d3748] flex items-center justify-center p-4 font-sans">
                        <div className="bg-white max-w-md w-full rounded-xl shadow-2xl overflow-hidden p-6 sm:p-8 space-y-6 animate-in zoom-in duration-300">
                        <div className="text-center">
                            <h1 className="text-3xl sm:text-4xl font-black text-[#006400] tracking-wider mb-1">СИНТЕЗ</h1>
                            <p className="text-gray-400 text-xs sm:text-sm">Хімічна стратегія</p>
                        </div>
                        <input type="text" value={playerName} onChange={e=>setPlayerName(e.target.value)} className="w-full border-2 border-gray-200 p-3 rounded-lg focus:border-green-600 outline-none" placeholder="Ваше ім'я"/>
                        <button onClick={createGame} className="w-full bg-green-700 hover:bg-green-800 text-white p-3 rounded-lg font-bold transition-all shadow-lg flex items-center justify-center gap-2">
                            <Atom size={20}/> Створити Гру
                        </button>
                        <div className="flex items-center gap-2">
                            <div className="h-px bg-gray-200 flex-grow"></div>
                            <span className="text-gray-400 text-[10px] uppercase">або</span>
                            <div className="h-px bg-gray-200 flex-grow"></div>
                        </div>
                        <div className="flex gap-2">
                            <input type="text" value={targetGameId} onChange={e=>setTargetGameId(e.target.value)} className="flex-grow border-2 border-gray-200 p-3 rounded-lg uppercase tracking-widest font-mono text-sm" placeholder="КОД"/>
                            <button onClick={()=>joinGame(targetGameId)} className="bg-blue-600 hover:bg-blue-700 text-white px-4 sm:px-6 rounded-lg font-bold shadow-lg text-sm sm:text-base">Увійти</button>
                        </div>
                        {notification && <div className="bg-red-50 text-red-600 p-3 rounded text-center text-xs sm:text-sm border border-red-100">{notification.msg}</div>}
                        </div>
                    </div>
                );
            }

            if (gameData.status === 'waiting') {
                return (
                    <div className="min-h-screen bg-[#f7f7f7] flex flex-col items-center justify-center p-4">
                        <div className="bg-white p-6 sm:p-8 rounded-2xl shadow-xl w-full max-w-lg text-center border-t-8 border-[#006400]">
                        <h2 className="text-2xl sm:text-3xl font-bold mb-4 text-[#006400] font-serif">Кімната: {gameId}</h2>
                        <div className="bg-gray-50 rounded-xl p-4 mb-6">
                            <h3 className="text-xs uppercase text-gray-400 font-bold mb-3 tracking-widest">Гравці в очікуванні</h3>
                            <div className="space-y-2">
                            {gameData.players.map((p,i) => (
                                <div key={i} className="flex items-center gap-3 p-2 bg-white border border-gray-100 rounded-lg shadow-sm">
                                <div className="w-8 h-8 rounded-full bg-gradient-to-br from-green-400 to-green-600 text-white flex items-center justify-center font-bold text-sm">{p.name[0]}</div>
                                <span className="font-bold text-gray-700 text-sm">{p.name}</span>
                                {i===0 && <Crown size={16} className="text-yellow-500 ml-auto"/>}
                                </div>
                            ))}
                            {[...Array(4 - gameData.players.length)].map((_, i) => (
                                <div key={`empty-${i}`} className="p-2 border border-dashed border-gray-300 rounded-lg text-gray-400 text-xs sm:text-sm flex items-center justify-center gap-2">
                                <Loader2 size={14} className="animate-spin"/> Очікування гравця...
                                </div>
                            ))}
                            </div>
                        </div>
                        {isHost ? (
                            <button onClick={startGame} className="w-full bg-[#006400] text-[#fceeb5] py-4 rounded-xl font-bold text-lg shadow-xl hover:scale-[1.02] transition-transform flex items-center justify-center gap-2">
                                <Play fill="currentColor"/> Розпочати
                            </button>
                        ) : <p className="text-gray-500 animate-pulse text-sm">Чекаємо організатора...</p>}
                        </div>
                    </div>
                );
            }

            if (gameData.status === 'finished') {
                const winner = gameData.players.reduce((p, c) => (p.score > c.score) ? p : c);
                return (
                    <div className="h-screen bg-gray-900 flex flex-col items-center justify-center text-white p-4 text-center">
                        <Crown size={64} className="text-yellow-400 mb-6 drop-shadow-[0_0_15px_rgba(250,204,21,0.5)]"/>
                        <h1 className="text-4xl sm:text-6xl font-black mb-4 font-serif">{winner.name}</h1>
                        <p className="text-lg sm:text-2xl text-gray-300 mb-8">Великий Майстер Синтезу ({winner.score} VP)</p>
                        <button onClick={()=>window.location.reload()} className="px-8 py-3 bg-white text-black font-bold rounded-full hover:bg-gray-200">До Головного Меню</button>
                    </div>
                );
            }

            return (
                <div className="h-screen bg-[#e8e8e8] flex flex-col overflow-hidden font-sans">
                    {/* HEADER */}
                    <header className="bg-white border-b px-3 sm:px-4 py-2 flex justify-between items-center shadow-sm z-30 shrink-0">
                        <div className="flex items-center gap-2 sm:gap-3">
                        <div className="bg-[#006400] text-[#fceeb5] px-2 sm:px-3 py-1 rounded font-bold font-serif shadow-sm tracking-wider text-xs sm:text-sm">{gameId}</div>
                        <div className="text-[10px] sm:text-xs text-gray-400 hidden sm:block">Колода: {gameData.elementDeck.length} | Молекули: {gameData.moleculeDeck.length}</div>
                        </div>
                        
                        <div className="flex items-center gap-2">
                            {/* Mobile Menu Toggle */}
                            <button 
                                className="lg:hidden p-2 text-gray-600 hover:bg-gray-100 rounded-full"
                                onClick={() => setMobileMenuOpen(true)}
                            >
                                <Menu size={20} />
                            </button>

                            <div className={`px-3 sm:px-4 py-1.5 rounded-full font-bold text-[10px] sm:text-sm transition-colors ${isMyTurn ? 'bg-green-100 text-green-800 ring-2 ring-green-500 shadow-lg scale-105' : 'bg-gray-100 text-gray-500'}`}>
                            {isMyTurn ? "ВАШ ХІД" : `Хід: ${gameData.players[gameData.turnIndex].name}`}
                            </div>
                            
                            <button className="text-gray-400 hover:text-red-500 hidden sm:block" onClick={()=>setGameId('')}><LogOut size={20}/></button>
                        </div>
                    </header>

                    {/* MOBILE MENU MODAL */}
                    {isMobileMenuOpen && (
                        <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none">
                        <div className="absolute inset-0 bg-black/40 pointer-events-auto" onClick={() => setMobileMenuOpen(false)}></div>
                        <div className="bg-white w-full sm:max-w-md sm:rounded-2xl rounded-t-2xl shadow-2xl p-4 pointer-events-auto animate-in slide-in-from-bottom-10 max-h-[80vh] flex flex-col">
                            <div className="flex justify-between items-center mb-4 border-b pb-2">
                                <h2 className="font-bold text-lg text-[#006400]">Інфо про гру</h2>
                                <button onClick={() => setMobileMenuOpen(false)} className="p-1 bg-gray-100 rounded-full"><X size={20}/></button>
                            </div>
                            
                            <div className="flex gap-2 mb-4 bg-gray-100 p-1 rounded-lg">
                                <button 
                                    onClick={() => setMobileTab('players')}
                                    className={`flex-1 py-2 rounded-md text-sm font-bold transition-all ${mobileTab === 'players' ? 'bg-white shadow text-[#006400]' : 'text-gray-500'}`}
                                >
                                    Гравці
                                </button>
                                <button 
                                    onClick={() => setMobileTab('logs')}
                                    className={`flex-1 py-2 rounded-md text-sm font-bold transition-all ${mobileTab === 'logs' ? 'bg-white shadow text-[#006400]' : 'text-gray-500'}`}
                                >
                                    Події
                                </button>
                            </div>

                            <div className="flex-grow overflow-y-auto min-h-[200px]">
                                {mobileTab === 'players' ? (
                                    <div className="space-y-2">
                                        {gameData.players.map((p, idx) => (
                                            <div key={p.uid} className={`flex items-center justify-between p-3 rounded-xl ${gameData.turnIndex === idx ? 'bg-green-50 border border-green-200' : 'bg-gray-50'}`}>
                                                <div className="flex items-center gap-3">
                                                <div className={`w-2 h-2 rounded-full ${gameData.turnIndex === idx ? 'bg-green-500' : 'bg-gray-300'}`}></div>
                                                <div className="flex flex-col">
                                                    <span className="font-bold text-sm">{p.name} {p.uid === user.uid && '(Ви)'}</span>
                                                    <span className="text-xs text-gray-400">Карт: {p.hand.length} | Мол: {p.molecules.length}</span>
                                                </div>
                                                </div>
                                                <div className="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-md font-bold">{p.score} VP</div>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="space-y-2 text-xs font-mono text-gray-600">
                                        {gameData.logs.slice(-20).reverse().map((l,i)=>(
                                            <div key={i} className="border-l-2 border-gray-200 pl-2 py-1">
                                                <span className="opacity-50 text-[10px] mr-2">{new Date(l.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                                                {l.text}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                            <div className="mt-4 pt-4 border-t text-center text-xs text-gray-400">
                                Колода: {gameData.elementDeck.length} | Ринок: {gameData.market.length}
                            </div>
                        </div>
                        </div>
                    )}

                    {/* MAIN AREA */}
                    <main className="flex-grow flex overflow-hidden relative">
                        
                        {/* Trade Overlay (Receiver) */}
                        {gameData.activeTrade && gameData.activeTrade.targetUid === user.uid && (
                            <div className="absolute inset-0 bg-black/60 z-50 flex items-center justify-center backdrop-blur-sm p-4">
                                <div className="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full animate-in zoom-in duration-200">
                                    <h3 className="text-xl font-bold mb-4 text-center text-gray-800">Пропозиція обміну!</h3>
                                    <div className="bg-gray-50 p-4 rounded-xl border border-gray-100 flex items-center justify-between mb-6">
                                        <div className="text-center">
                                            <div className="text-[10px] sm:text-xs text-gray-400 uppercase font-bold mb-1">{gameData.activeTrade.fromName} дає</div>
                                            <div className="font-black text-2xl sm:text-3xl text-blue-600">{gameData.activeTrade.giveCard}</div>
                                        </div>
                                        <RefreshCcw className="text-gray-300" />
                                        <div className="text-center">
                                            <div className="text-[10px] sm:text-xs text-gray-400 uppercase font-bold mb-1">Хоче</div>
                                            <div className="font-black text-2xl sm:text-3xl text-green-600">{gameData.activeTrade.wantCard}</div>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <button onClick={() => respondToTrade(false)} className="py-3 bg-red-50 text-red-600 rounded-lg font-bold hover:bg-red-100 transition-colors text-sm">Відхилити</button>
                                        <button onClick={() => respondToTrade(true)} className="py-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 shadow-lg shadow-green-200 transition-all text-sm">Прийняти</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Trade Player Selector */}
                        {tradeMode && tradeStep === 2 && (
                            <div className="absolute inset-0 bg-black/40 z-40 flex items-center justify-center p-4 backdrop-blur-sm">
                                <div className="bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm animate-in fade-in slide-in-from-bottom-4">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-lg">Оберіть партнера</h3>
                                    <button onClick={()=>setTradeMode(false)} className="bg-gray-100 p-1 rounded-full hover:bg-gray-200"><X size={18}/></button>
                                </div>
                                <div className="space-y-2">
                                    {gameData.players.map(p => {
                                        if (p.uid === user.uid) return null;
                                        return (
                                            <button 
                                                key={p.uid} 
                                                onClick={() => sendTradeOffer(p.uid)}
                                                className="w-full p-4 bg-gray-50 hover:bg-blue-50 hover:border-blue-200 border border-transparent text-gray-700 font-bold rounded-xl flex items-center justify-between transition-all group"
                                            >
                                                <div className="flex items-center gap-3">
                                                    <div className="w-8 h-8 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center text-sm">{p.name[0]}</div>
                                                    <span>{p.name}</span>
                                                </div>
                                                <ArrowRightLeft size={16} className="text-gray-300 group-hover:text-blue-500"/>
                                            </button>
                                        )
                                    })}
                                </div>
                                </div>
                            </div>
                        )}

                        {/* Desktop Sidebar */}
                        <aside className="w-64 bg-white border-r hidden lg:flex flex-col shadow-lg z-20">
                            <div className="p-5 border-b bg-gray-50">
                                <h3 className="text-xs font-black text-gray-400 uppercase tracking-widest mb-4">Таблиця лідерів</h3>
                                {gameData.players.map((p, idx) => (
                                    <div key={p.uid} className={`flex items-center justify-between p-3 rounded-xl mb-2 transition-all ${gameData.turnIndex === idx ? 'bg-white border-2 border-green-500 shadow-md transform scale-105' : 'bg-gray-100 border border-transparent'}`}>
                                        <div className="flex items-center gap-2 overflow-hidden">
                                        <div className={`w-2 h-2 rounded-full ${gameData.turnIndex === idx ? 'bg-green-500 animate-pulse' : 'bg-gray-300'}`}></div>
                                        <span className="font-bold text-sm truncate">{p.name}</span>
                                        </div>
                                        <div className="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-md font-bold shadow-sm">{p.score} VP</div>
                                    </div>
                                ))}
                            </div>
                            <div className="flex-grow flex flex-col p-4 overflow-hidden bg-white">
                                <h3 className="text-xs font-black text-gray-400 uppercase tracking-widest mb-2">Хроніка</h3>
                                <div className="flex-grow overflow-y-auto text-xs space-y-3 font-mono text-gray-600 pr-2 custom-scrollbar">
                                    {gameData.logs.slice(-15).reverse().map((l,i)=>(
                                        <div key={i} className="border-l-2 border-gray-200 pl-2 py-1 opacity-80 hover:opacity-100 hover:border-green-400 transition-colors">
                                            <span className="opacity-50 text-[10px] block">{new Date(l.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                                            {l.text}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </aside>

                        {/* Market Area */}
                        <section className="flex-grow bg-[#dcdcdc] p-2 sm:p-4 overflow-y-auto relative">
                            <div className="absolute top-0 left-0 w-full h-full pointer-events-none opacity-5 bg-[radial-gradient(#006400_1px,transparent_1px)] [background-size:16px_16px]"></div>
                            
                            <div className="max-w-5xl mx-auto pb-40 sm:pb-32">
                            <div className="flex items-center gap-2 mb-4 sm:mb-6 opacity-70 px-2">
                                <LayoutGrid size={18} />
                                <span className="font-bold text-xs sm:text-sm uppercase tracking-widest">Арена Молекул ({gameData.market.length})</span>
                            </div>
                            
                            <div className="flex flex-wrap justify-center gap-2 sm:gap-6">
                                {gameData.market.map(mol => (
                                    <MoleculeCard 
                                        key={mol.uniqueId} 
                                        mol={mol} 
                                        canBuy={isMyTurn && gameData.turnPhase === 'action' && checkRecipe(myPlayer.hand, mol.req)} 
                                        onBuy={synthesize} 
                                    />
                                ))}
                                {[...Array(4 - gameData.market.length)].map((_, i) => (
                                    <div key={`placeholder-${i}`} className="w-[45%] sm:w-36 h-[160px] sm:h-[180px] rounded-xl border-2 border-dashed border-gray-400 flex items-center justify-center opacity-30">
                                        <FlaskConical size={32}/>
                                    </div>
                                ))}
                            </div>
                            </div>
                        </section>
                    </main>

                    {/* FOOTER */}
                    <footer className="bg-white border-t p-2 z-40 relative shadow-[0_-5px_25px_rgba(0,0,0,0.1)] pb-safe">
                        <div className="max-w-6xl mx-auto">
                        {/* Notifications/Hints */}
                        {tradeMode && tradeStep === 0 && <div className="text-center text-blue-600 font-bold text-xs sm:text-sm mb-2 animate-pulse bg-blue-50 py-1 rounded-full mx-auto w-max px-4">Оберіть карту для обміну</div>}
                        {selectedCards.length > 0 && !tradeMode && <div className="text-center text-gray-500 text-[10px] sm:text-xs mb-2 bg-gray-100 py-0.5 rounded-full mx-auto w-max px-3">Обрано: {selectedCards.length}</div>}

                        {/* HAND */}
                        <div className="w-full overflow-x-auto h-42 sm:h-52 mb-2 pb-4 px-2 sm:px-4 scrollbar-hide flex items-end">
                            <div className="flex items-end mx-auto min-w-min pl-6 sm:pl-10 pr-6">
                                {sortedHandMap.map(({ card, originalIdx }, i) => (
                                    <ElementCard 
                                        key={`${originalIdx}-${i}`}
                                        type={card}
                                        overlap={true} 
                                        style={{ zIndex: selectedCards.includes(originalIdx) ? 50 : i, transformOrigin: 'bottom center', transform: selectedCards.includes(originalIdx) ? 'translateY(-15px)' : `rotate(${(i - sortedHandMap.length/2) * 2}deg)` }}
                                        selected={selectedCards.includes(originalIdx)}
                                        onClick={() => {
                                            if (tradeMode && tradeStep === 0) {
                                                setSelectedCards([originalIdx]);
                                                setTimeout(() => initPlayerTrade(), 150);
                                            } else {
                                                toggleSelectCard(originalIdx);
                                            }
                                        }}
                                    />
                                ))}
                                {sortedHandMap.length === 0 && (
                                    <div className="text-gray-400 text-xs sm:text-sm font-bold border-2 border-dashed border-gray-300 rounded-xl w-20 h-32 sm:w-24 sm:h-36 flex items-center justify-center flex-shrink-0">
                                        Пусто
                                    </div>
                                )}
                            </div>
                        </div>
                        
                        {/* CONTROLS */}
                        <div className="flex gap-2 sm:gap-3 justify-start sm:justify-center pb-2 overflow-x-auto items-center px-1 scrollbar-hide">
                            {isMyTurn && gameData.turnPhase === 'draw' && (
                                <button onClick={() => drawCards(2)} className="bg-gradient-to-r from-blue-600 to-blue-500 text-white px-6 sm:px-8 py-2 sm:py-3 rounded-full font-bold shadow-xl hover:shadow-2xl hover:-translate-y-1 transition-all flex items-center gap-2 text-sm sm:text-base whitespace-nowrap mx-auto">
                                    <Copy size={18}/> Взяти ресурси
                                </button>
                            )}

                            {isMyTurn && gameData.turnPhase === 'action' && !tradeMode && (
                                <div className="flex gap-2 mx-auto">
                                    <button 
                                        onClick={startTrade3to1} 
                                        disabled={selectedCards.length !== 3} 
                                        className="bg-yellow-50 text-yellow-700 border border-yellow-200 px-3 sm:px-5 py-2 sm:py-2.5 rounded-full font-bold text-xs sm:text-sm flex items-center gap-1 sm:gap-2 hover:bg-yellow-100 transition-colors disabled:opacity-50 disabled:grayscale whitespace-nowrap"
                                    >
                                        <RefreshCcw size={14}/> <span className="hidden sm:inline">Обмін</span> 3:1
                                    </button>
                                    
                                    <button 
                                        onClick={() => { setSelectedCards([]); setTradeMode(true); setTradeStep(0); }} 
                                        className="bg-indigo-50 text-indigo-700 border border-indigo-200 px-3 sm:px-5 py-2 sm:py-2.5 rounded-full font-bold text-xs sm:text-sm flex items-center gap-1 sm:gap-2 hover:bg-indigo-100 transition-colors whitespace-nowrap"
                                    >
                                        <Users size={14}/> <span className="hidden sm:inline">Обмін</span> Гравці
                                    </button>

                                    <div className="w-px h-6 sm:h-8 bg-gray-300 mx-1 sm:mx-2"></div>

                                    {myPlayer.hand.length > 10 ? (
                                        <button onClick={discardSelected} className="bg-red-500 text-white px-4 sm:px-8 py-2 sm:py-3 rounded-full font-bold shadow-lg animate-bounce flex items-center gap-2 text-xs sm:text-sm whitespace-nowrap">
                                        <AlertTriangle size={16}/> Скинути ({selectedCards.length})
                                        </button>
                                    ) : (
                                        <button onClick={endTurn} className="bg-gradient-to-r from-green-600 to-green-500 text-white px-4 sm:px-8 py-2 sm:py-3 rounded-full font-bold shadow-xl hover:shadow-2xl hover:-translate-y-1 transition-all flex items-center gap-2 text-xs sm:text-sm whitespace-nowrap">
                                        <Check size={16}/> <span className="hidden sm:inline">Завершити</span> Хід
                                        </button>
                                    )}
                                </div>
                            )}
                            
                            {tradeMode && (
                                <button onClick={() => { setTradeMode(false); setTradeStep(0); setSelectedCards([]); }} className="bg-gray-200 text-gray-600 px-6 py-2 rounded-full font-bold text-xs sm:text-sm hover:bg-gray-300 mx-auto">
                                    Скасувати
                                </button>
                            )}
                        </div>
                        </div>
                    </footer>
                    
                    {/* MODALS */}
                    <ElementSelectorModal isOpen={is3to1ModalOpen} onClose={() => set3to1ModalOpen(false)} onSelect={confirmTrade3to1} title="Отримайте ресурс" />
                    <ElementSelectorModal isOpen={tradeMode && tradeStep === 1} onClose={() => setTradeMode(false)} onSelect={handleTradeStepSelection} title="Що ви хочете отримати?" />

                    {notification && (
                        <div className={`fixed top-16 sm:top-24 left-1/2 -translate-x-1/2 px-4 sm:px-6 py-2 sm:py-3 rounded-xl shadow-2xl text-white font-bold z-[100] animate-in slide-in-from-top-4 text-xs sm:text-sm whitespace-nowrap ${notification.type==='error'?'bg-red-500':'bg-green-600'}`}>
                            {notification.msg}
                            {setTimeout(()=>setNotification(null), 3000) && ""}
                        </div>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<SynthesisGame />);
    </script>
</body>
</html>
